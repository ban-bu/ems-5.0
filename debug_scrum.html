<!DOCTYPE html>
<html>
<head>
    <title>Scrumæ•°æ®ç»“æ„è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .flow-summary { margin: 15px 0; }
        .flow-summary h5 { margin-bottom: 10px; color: #333; }
        .flow-summary ul { margin: 10px 0; padding-left: 20px; }
        .flow-summary li { margin: 5px 0; }
        .validation-issues { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; margin: 10px 0; }
        .validation-issues h6 { margin: 0 0 8px 0; color: #856404; }
        .validation-issues ul { margin: 5px 0; padding-left: 15px; }
        .ai-generated-badge { background: #e3f2fd; border: 1px solid #2196f3; border-radius: 4px; padding: 8px; margin: 10px 0; color: #1565c0; }
        details { margin: 10px 0; }
        details summary { cursor: pointer; font-weight: bold; padding: 5px; background: #f1f1f1; border-radius: 3px; }
        details[open] summary { margin-bottom: 10px; }
        /* === Kanban & Gantt Debug Styles === */
        .viz-actions { display: flex; gap: 10px; margin: 10px 0 15px; }
        .viz-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1100px) { .viz-grid { grid-template-columns: 1fr 1fr; } }
        .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .kanban-column { background: #f8f9fa; border-radius: 10px; padding: 12px; border: 2px dashed #e0e0e0; }
        .kanban-column .column-header { display:flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom:1px solid #e0e0e0; margin-bottom: 10px; }
        .kanban-column .column-header h4 { margin: 0; font-size: 16px; color: #333; display:flex; align-items:center; gap:8px; }
        .kanban-column .task-list { display:flex; flex-direction: column; gap: 10px; min-height: 200px; }
        .task-card { background: #fff; border-radius: 8px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #e0e0e0; }
        .task-header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 6px; }
        .task-priority-dot { width:8px; height:8px; border-radius:50%; }
        .task-points { font-size: 12px; background:#f1f3f5; color:#495057; padding: 2px 6px; border-radius:4px; }
        .task-title { margin: 0 0 6px 0; font-weight:600; color:#2c3e50; font-size: 14px; }
        .task-desc { color:#666; font-size: 13px; line-height:1.4; margin-bottom: 6px; }
        .task-meta { display:flex; justify-content: space-between; align-items:center; font-size: 12px; color:#888; }
        .task-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
        .task-tag { background:#e9ecef; color:#495057; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
        .task-progress-bar { height:6px; background:#e9ecef; border-radius:3px; overflow:hidden; margin:6px 0; }
        .task-progress-fill { height:100%; background: linear-gradient(90deg,#28a745,#20c997); }
        .count-badge { background:#007bff; color:#fff; border-radius:12px; padding: 2px 8px; font-size:12px; font-weight:600; }
        .gantt-container { background:#fff; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border:1px solid #e0e0e0; }
        .gantt-header-row { display:grid; grid-template-columns: 220px 1fr; background:#f8f9fa; border-bottom:1px solid #e0e0e0; border-radius:10px 10px 0 0; }
        .gantt-task-col-title { padding:10px; font-weight:600; color:#333; border-right:1px solid #e0e0e0; }
        .gantt-dates { display:flex; min-width: 720px; }
        .gantt-date { flex:1; padding:10px 4px; text-align:center; font-size:12px; color:#666; border-right:1px solid #eee; }
        .gantt-row { display:grid; grid-template-columns: 220px 1fr; border-bottom:1px solid #f1f1f1; min-height: 42px; }
        .gantt-task-info { padding:8px 10px; background:#fff; border-right:1px solid #f1f1f1; }
        .gantt-task-title { font-size:13px; color:#333; font-weight:600; margin-bottom:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .gantt-task-meta { font-size:12px; color:#888; }
        .gantt-timeline { position: relative; padding: 8px; min-width: 720px; background:#fafafa; }
        .gantt-bar { position:absolute; height:18px; top: 10px; border-radius:4px; display:flex; align-items:center; padding:0 6px; color:#fff; font-size:11px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); overflow:hidden; }
        .gantt-bar.todo { background:#6c757d; }
        .gantt-bar.in-progress { background:#ffc107; color:#212529; }
        .gantt-bar.done { background:#28a745; }
        .empty-note { padding:12px; color:#666; font-size: 14px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç¢³æ’æ”¾ç®¡ç†ç³»ç»Ÿè°ƒè¯•å·¥å…·</h1>
    <div class="debug-section success">
        <h3>ğŸ¯ åŠŸèƒ½è¯´æ˜</h3>
        <p><strong>æ­¤å·¥å…·åŒ…å«ä»¥ä¸‹è°ƒè¯•åŠŸèƒ½ï¼š</strong></p>
        <ul>
            <li>ğŸ“‹ <strong>Scrumä»»åŠ¡ç”Ÿæˆ</strong>ï¼šæµ‹è¯•Fallbackå‡½æ•°ã€æ•°æ®æ˜ å°„ã€å®Œæ•´æµç¨‹</li>
            <li>ğŸ¤– <strong>AIåˆ†æåŠŸèƒ½</strong>ï¼šæµ‹è¯•çœŸå®AIé©±åŠ¨çš„ç¢³æ’æ”¾å’Œæ—¶é—´çº¿åˆ†æ</li>
            <li>ğŸ” <strong>å®Œæ•´æµç¨‹</strong>ï¼šç«¯åˆ°ç«¯æµ‹è¯•æ–‡æ¡£å¤„ç†åˆ°æ•°æ®ç”Ÿæˆçš„å®Œæ•´è¿‡ç¨‹</li>
            <li>ğŸ“º <strong>æ§åˆ¶å°è¾“å‡º</strong>ï¼šæ‰€æœ‰AIè¾“å…¥è¾“å‡ºéƒ½åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¯¦ç»†æ˜¾ç¤º</li>
        </ul>
        <p><strong>ğŸ’¡ ä½¿ç”¨å»ºè®®ï¼š</strong>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°ï¼ŒæŸ¥çœ‹è¯¦ç»†çš„AIè°ƒç”¨è¿‡ç¨‹å’Œæ•°æ®æµã€‚</p>
    </div>
    
    <div class="debug-section">
        <h3>æµ‹è¯• buildScrumPlanFallback å‡½æ•°</h3>
        <button onclick="testFallbackFunction()">æµ‹è¯•Fallbackå‡½æ•°</button>
        <div id="fallbackResult"></div>
    </div>

    <div class="debug-section">
        <h3>æµ‹è¯•æ•°æ®æ˜ å°„é€»è¾‘</h3>
        <button onclick="testDataMapping()">æµ‹è¯•æ•°æ®æ˜ å°„</button>
        <div id="mappingResult"></div>
    </div>

    <div class="debug-section">
        <h3>æµ‹è¯•å®Œæ•´æµç¨‹</h3>
        <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
        <div id="completeResult"></div>
    </div>

    <div class="debug-section">
        <h3>ğŸ¤– æµ‹è¯•AIåˆ†æåŠŸèƒ½</h3>
        <button onclick="testAIAnalysis()">æµ‹è¯•AIç¢³æ’æ”¾åˆ†æ</button>
        <div id="aiAnalysisResult"></div>
    </div>

    <div class="debug-section">
        <h3>ğŸ” æµ‹è¯•AIåˆ†æå®Œæ•´æµç¨‹</h3>
        <button onclick="testFullAIFlow()">æµ‹è¯•å®Œæ•´AIåˆ†ææµç¨‹</button>
        <div id="fullAIResult"></div>
    </div>

    <div class="debug-section">
        <h3>ğŸ“Š å¯è§†åŒ–ç»“æœ</h3>
        <p>å½“ä¸Šé¢çš„æµ‹è¯•ç”Ÿæˆäº†ä»»åŠ¡åï¼Œå¯åœ¨æ­¤æ¸²æŸ“ Kanban å’Œç”˜ç‰¹å›¾ã€‚</p>
        <div class="viz-actions">
            <button onclick="renderKanbanBoard()">æ¸²æŸ“Kanban</button>
            <button onclick="renderGanttChart()">æ¸²æŸ“ç”˜ç‰¹å›¾</button>
        </div>
        <div class="viz-grid">
            <div>
                <h4>çœ‹æ¿è§†å›¾</h4>
                <div id="kanbanBoard" class="kanban-board"></div>
            </div>
            <div>
                <h4>ç”˜ç‰¹å›¾è§†å›¾</h4>
                <div id="ganttChart" class="gantt-container"></div>
            </div>
        </div>
    </div>

    <script>
        // å¤åˆ¶å…³é”®å‡½æ•°è¿›è¡Œç‹¬ç«‹æµ‹è¯•
        function buildScrumPlanFallback(acceptedByArea, analysis) {
            const tasks = [];
            const today = new Date();
            let dayOffset = 0;
            
            Object.keys(acceptedByArea || {}).forEach(area => {
                (acceptedByArea[area] || []).forEach((title, idx) => {
                    const start = new Date(today.getTime() + dayOffset*86400000);
                    const end = new Date(start.getTime() + (2 + (idx%3))*86400000);
                    tasks.push({
                        title: `${area} - æ‰§è¡Œã€Œ${title}ã€`,
                        desc: 'æ ¹æ®å·²é‡‡çº³å»ºè®®è½å®æ‰§è¡Œã€éªŒè¯ä¸å¤ç›˜',
                        priority: idx%2===0 ? 'high' : 'medium',
                        storyPoints: [3,5,8,13][idx%4],
                        startDate: start.toISOString().slice(0,10),
                        endDate: end.toISOString().slice(0,10),
                        status: idx%3===0 ? 'in-progress' : 'todo',
                        tags: [area]
                    });
                    dayOffset += 1;
                });
            });
            
            // è‹¥å°šæœªé‡‡çº³å»ºè®®ï¼ŒåŸºäºé«˜å€¼æ¿å—ç”ŸæˆåŸºæœ¬ä»»åŠ¡
            if (tasks.length === 0 && analysis?.emissions) {
                const sorted = Object.entries(analysis.emissions).sort((a,b)=> (b[1].value||0) - (a[1].value||0)).slice(0,3);
                sorted.forEach(([k,v],i)=>{
                    const start = new Date(today.getTime() + i*86400000);
                    const end = new Date(start.getTime() + 3*86400000);
                    tasks.push({
                        title: `é™ä½ã€Œ${k}ã€é˜¶æ®µæ’æ”¾`,
                        desc: 'åˆ¶å®šå¹¶æ‰§è¡Œé™ç¢³ä¸¾æªï¼Œè·Ÿè¸ªæŒ‡æ ‡',
                        priority: i===0?'high':'medium',
                        storyPoints: [8,5,3][i] || 5,
                        startDate: start.toISOString().slice(0,10),
                        endDate: end.toISOString().slice(0,10),
                        status: 'todo',
                        tags: ['é™ç¢³']
                    });
                });
            }
            return { sprint: {}, tasks };
        }

        function testFallbackFunction() {
            const testData = {
                acceptedByArea: {
                    'ææ–™é€‰æ‹©': ['ä½¿ç”¨å¯å›æ”¶ææ–™', 'ä¼˜åŒ–åŒ…è£…è®¾è®¡'],
                    'ç”Ÿäº§å·¥è‰º': ['æ”¹è¿›ç”Ÿäº§æµç¨‹', 'é™ä½èƒ½è€—']
                },
                analysis: {
                    emissions: {
                        'manufacturing': { value: 100 },
                        'logistics': { value: 80 },
                        'packaging': { value: 60 }
                    }
                }
            };

            try {
                const result = buildScrumPlanFallback(testData.acceptedByArea, testData.analysis);
                document.getElementById('fallbackResult').innerHTML = `
                    <div class="success">
                        <h4>âœ… Fallbackå‡½æ•°æµ‹è¯•æˆåŠŸ</h4>
                        <p><strong>è¿”å›ç±»å‹:</strong> ${typeof result}</p>
                        <p><strong>ä»»åŠ¡æ•°é‡:</strong> ${result.tasks ? result.tasks.length : 'æ— '}</p>
                        <p><strong>ä»»åŠ¡ç±»å‹:</strong> ${Array.isArray(result.tasks) ? 'Array' : typeof result.tasks}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                document.getElementById('fallbackResult').innerHTML = `
                    <div class="error">
                        <h4>âŒ Fallbackå‡½æ•°æµ‹è¯•å¤±è´¥</h4>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        function testDataMapping() {
            // æµ‹è¯•æ•°æ®æ˜ å°„é€»è¾‘
            const mockPlan = {
                sprint: {},
                tasks: [
                    { title: 'ä»»åŠ¡1', status: 'todo', priority: 'high', storyPoints: 5 },
                    { title: 'ä»»åŠ¡2', status: 'in-progress', priority: 'medium', storyPoints: 3 },
                    { title: 'ä»»åŠ¡3', status: 'done', priority: 'low', storyPoints: 8 }
                ]
            };

            try {
                const buckets = { 'todo': [], 'in-progress': [], 'done': [] };
                const tasks = Array.isArray(mockPlan?.tasks) ? mockPlan.tasks : [];
                
                const normalizePriority = (p) => (p==='high'||p==='medium'||p==='low') ? p : 'medium';
                const normalizeStatus = (s) => (s==='todo'||s==='in-progress'||s==='done') ? s : 'todo';

                tasks.forEach((t, idx) => {
                    const task = {
                        id: `test-${Date.now()}-${idx}`,
                        title: t.title || `ä»»åŠ¡${idx+1}`,
                        description: t.desc || '',
                        assignee: 'æµ‹è¯•ç”¨æˆ·',
                        priority: normalizePriority(t.priority),
                        storyPoints: Number.isFinite(t.storyPoints) ? t.storyPoints : 5,
                        startDate: new Date().toISOString().slice(0,10),
                        endDate: new Date(Date.now()+3*86400000).toISOString().slice(0,10),
                        tags: Array.isArray(t.tags) ? t.tags : [],
                        progress: t.status==='in-progress' ? 30 : (t.status==='done'? 100 : undefined)
                    };
                    buckets[normalizeStatus(t.status)].push(task);
                });

                const finalData = Object.assign(buckets, { __auto: true });

                // ä¿å­˜ä¸ºå…¨å±€ä»»åŠ¡å¹¶æ¸²æŸ“
                window.scrumTasks = finalData;
                safeRenderVisuals();

                document.getElementById('mappingResult').innerHTML = `
                    <div class="success">
                        <h4>âœ… æ•°æ®æ˜ å°„æµ‹è¯•æˆåŠŸ</h4>
                        <p><strong>åŸå§‹ä»»åŠ¡æ•°:</strong> ${tasks.length}</p>
                        <p><strong>æ˜ å°„åç»“æ„:</strong></p>
                        <ul>
                            <li>todo: ${finalData.todo.length} ä¸ªä»»åŠ¡</li>
                            <li>in-progress: ${finalData['in-progress'].length} ä¸ªä»»åŠ¡</li>
                            <li>done: ${finalData.done.length} ä¸ªä»»åŠ¡</li>
                        </ul>
                        <pre>${JSON.stringify(finalData, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                document.getElementById('mappingResult').innerHTML = `
                    <div class="error">
                        <h4>âŒ æ•°æ®æ˜ å°„æµ‹è¯•å¤±è´¥</h4>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        function testCompleteFlow() {
            // æµ‹è¯•å®Œæ•´çš„æ•°æ®ç”Ÿæˆå’Œæ¸²æŸ“å‡†å¤‡æµç¨‹
            try {
                // Step 1: ç”Ÿæˆfallbackæ•°æ®
                const acceptedByArea = {
                    'ææ–™é€‰æ‹©': ['ä½¿ç”¨å¯å›æ”¶ææ–™'],
                    'ç”Ÿäº§å·¥è‰º': ['æ”¹è¿›ç”Ÿäº§æµç¨‹']
                };
                const analysis = {};
                
                const plan = buildScrumPlanFallback(acceptedByArea, analysis);
                
                // Step 2: æ˜ å°„æ•°æ®
                const buckets = { 'todo': [], 'in-progress': [], 'done': [] };
                const tasks = Array.isArray(plan?.tasks) ? plan.tasks : [];
                
                const normalizePriority = (p) => (p==='high'||p==='medium'||p==='low') ? p : 'medium';
                const normalizeStatus = (s) => (s==='todo'||s==='in-progress'||s==='done') ? s : 'todo';

                tasks.forEach((t, idx) => {
                    const task = {
                        id: `test-${Date.now()}-${idx}`,
                        title: t.title || `ä»»åŠ¡${idx+1}`,
                        description: t.desc || '',
                        assignee: 'æµ‹è¯•ç”¨æˆ·',
                        priority: normalizePriority(t.priority),
                        storyPoints: Number.isFinite(t.storyPoints) ? t.storyPoints : 5,
                        startDate: t.startDate || new Date().toISOString().slice(0,10),
                        endDate: t.endDate || new Date(Date.now()+3*86400000).toISOString().slice(0,10),
                        tags: Array.isArray(t.tags) ? t.tags : [],
                        progress: t.status==='in-progress' ? 30 : (t.status==='done'? 100 : undefined)
                    };
                    buckets[normalizeStatus(t.status)].push(task);
                });

                const scrumTasks = Object.assign(buckets, { __auto: true });
                
                // Step 3: éªŒè¯æ¸²æŸ“å‡†å¤‡
                let renderReady = true;
                let renderIssues = [];
                
                Object.keys(scrumTasks).forEach(status => {
                    if (status !== '__auto' && status !== '__aiGenerated') {
                        if (!Array.isArray(scrumTasks[status])) {
                            renderReady = false;
                            renderIssues.push(`çŠ¶æ€ ${status} ä¸æ˜¯æ•°ç»„`);
                        }
                    }
                });

                document.getElementById('completeResult').innerHTML = `
                    <div class="${renderReady ? 'success' : 'error'}">
                        <h4>${renderReady ? 'âœ…' : 'âŒ'} å®Œæ•´æµç¨‹æµ‹è¯•${renderReady ? 'æˆåŠŸ' : 'å¤±è´¥'}</h4>
                        <p><strong>åŸå§‹è®¡åˆ’ä»»åŠ¡æ•°:</strong> ${plan.tasks?.length || 0}</p>
                        <p><strong>æ˜ å°„åä»»åŠ¡åˆ†å¸ƒ:</strong></p>
                        <ul>
                            <li>todo: ${scrumTasks.todo?.length || 0} ä¸ªä»»åŠ¡</li>
                            <li>in-progress: ${scrumTasks['in-progress']?.length || 0} ä¸ªä»»åŠ¡</li>
                            <li>done: ${scrumTasks.done?.length || 0} ä¸ªä»»åŠ¡</li>
                        </ul>
                        <p><strong>æ¸²æŸ“å‡†å¤‡çŠ¶æ€:</strong> ${renderReady ? 'å°±ç»ª' : 'æœ‰é—®é¢˜'}</p>
                        ${renderIssues.length > 0 ? `<p><strong>é—®é¢˜:</strong> ${renderIssues.join(', ')}</p>` : ''}
                        <details>
                            <summary>æŸ¥çœ‹å®Œæ•´æ•°æ®ç»“æ„</summary>
                            <pre>${JSON.stringify(scrumTasks, null, 2)}</pre>
                        </details>
                    </div>
                `;

                // ä¿å­˜ä¸ºå…¨å±€ä»»åŠ¡å¹¶æ¸²æŸ“
                window.scrumTasks = scrumTasks;
                safeRenderVisuals();
            } catch (error) {
                document.getElementById('completeResult').innerHTML = `
                    <div class="error">
                        <h4>âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥</h4>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                        <p><strong>é”™è¯¯å †æ ˆ:</strong></p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        // ==================== AIåˆ†æåŠŸèƒ½æµ‹è¯• ====================
        
        // æ¨¡æ‹Ÿæ–‡æ¡£æ•°æ®
        const MOCK_DOCUMENT_DATA = {
            content: "EcoLoopæ˜¯ä¸€æ¬¾é¢å‘åŸå¸‚é€šå‹¤çš„çº¯ç”µåŠ¨æ±½è½¦ï¼Œé‡‡ç”¨è½»é‡åŒ–é“åˆé‡‘è½¦èº«ï¼Œé…å¤‡é«˜æ•ˆæ°¸ç£åŒæ­¥ç”µæœºï¼Œç»­èˆªé‡Œç¨‹è¾¾åˆ°400å…¬é‡Œã€‚è½¦è¾†é‡‡ç”¨é”‚ç¦»å­ç”µæ± ç»„ï¼Œæ”¯æŒå¿«é€Ÿå……ç”µæŠ€æœ¯ã€‚æ•´è½¦é‡é‡æ§åˆ¶åœ¨1200å…¬æ–¤ï¼Œå…·å¤‡ä¼˜å¼‚çš„èƒ½è€—è¡¨ç°ã€‚ç”Ÿäº§è¿‡ç¨‹ä¸­é‡‡ç”¨ç¯ä¿ææ–™å’Œæ¸…æ´èƒ½æºï¼Œç¬¦åˆæ¬§ç›ŸRoHSæ ‡å‡†ã€‚",
            documentType: 'automotive'
        };

        const MOCK_SUPPLEMENT_DATA = {
            "ä¾›åº”å•†åœ°ç†ä½ç½®ä¿¡æ¯": "æ±Ÿè‹è‹å·ï¼ˆåŸºäºæ±½è½¦åˆ¶é€ äº§ä¸šé›†ç¾¤åˆ†æï¼‰",
            "åŸææ–™å…·ä½“è§„æ ¼å’Œæ¥æº": "é’¢æ-å®é’¢é›†å›¢ï¼Œæ©¡èƒ¶-ç±³å…¶æ—ï¼Œç”µæ± -æ¯”äºšè¿ª",
            "ç”Ÿäº§å·¥è‰ºè¯¦ç»†æµç¨‹": "å†²å‹æˆå‹â†’ç„Šæ¥è£…é…â†’æ¶‚è£…å¤„ç†â†’æ€»è£…è°ƒè¯•â†’è·¯è¯•æ£€éªŒ",
            "ç‰©æµè¿è¾“æ–¹å¼å’Œè·¯å¾„": "å¤šå¼è”è¿ï¼Œæµ·è¿+é™†è¿ç»“åˆï¼Œæˆæœ¬ä¼˜åŒ–12%",
            "äº§å“ä½¿ç”¨åœºæ™¯å’Œå‘¨æœŸ": "äº¤é€šå·¥å…·ï¼Œä½¿ç”¨å¯¿å‘½10-15å¹´"
        };

        // è·å–äº§å“ç±»å‹åç§°
        function getDocumentTypeName(type) {
            const typeNames = {
                'automotive': 'æ±½è½¦åˆ¶é€ ',
                'electronics': 'ç”µå­äº§å“',
                'textile': 'çººç»‡å“',
                'general': 'é€šç”¨äº§å“'
            };
            return typeNames[type] || type;
        }

        // AIåˆ†æç¢³æ’æ”¾å’Œæ—¶é—´çº¿æ•°æ®
        async function generateAIAnalysisData(documentContent, supplementData, productType) {
            console.log('%cğŸ¤– è¿›å…¥generateAIAnalysisDataå‡½æ•°', 'color: green; font-weight: bold;');
            console.log('å‡½æ•°å‚æ•°éªŒè¯:');
            console.log('- documentContentç±»å‹:', typeof documentContent, 'é•¿åº¦:', documentContent?.length);
            console.log('- supplementDataç±»å‹:', typeof supplementData, 'é”®æ•°:', Object.keys(supplementData || {}).length);
            console.log('- productType:', productType);
            
            const productTypeName = getDocumentTypeName(productType);
            console.log('- äº§å“ç±»å‹åç§°:', productTypeName);
            
            try {
                console.log('ğŸ¤– å¼€å§‹AIåˆ†æç¢³æ’æ”¾å’Œæ—¶é—´çº¿æ•°æ®...');
                console.log('ğŸ“¤ è¾“å…¥æ•°æ®:');
                console.log('- äº§å“ç±»å‹:', productTypeName);
                console.log('- æ–‡æ¡£å†…å®¹é•¿åº¦:', documentContent.length);
                console.log('- æ–‡æ¡£å†…å®¹é¢„è§ˆ:', documentContent.substring(0, 100) + '...');
                console.log('- è¡¥å……æ•°æ®:', supplementData);
                
                // æ„å»ºAIåˆ†ææç¤ºè¯
                const prompt = `ä½œä¸ºç¢³æ’æ”¾ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸè¯„ä¼°ä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹äº§å“çš„ç¢³æ’æ”¾å’Œæ—¶é—´çº¿æ•°æ®ã€‚

ã€äº§å“ä¿¡æ¯ã€‘
äº§å“ç±»å‹ï¼š${productTypeName}
æ–‡æ¡£å†…å®¹ï¼š${documentContent.substring(0, 1500)}
è¡¥å……ä¿¡æ¯ï¼š${Object.entries(supplementData).map(([key, value]) => `${key}: ${value}`).join(', ')}

è¯·ä¸ºè¯¥äº§å“ç”ŸæˆçœŸå®å¯ä¿¡çš„ç¢³æ’æ”¾å’Œæ—¶é—´çº¿åˆ†ææ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰ï¼š

{
  "emissions": {
    "procurement": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "åŸæ–™é‡‡è´­é˜¶æ®µæ’æ”¾æè¿°"},
    "manufacturing": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "ç”Ÿäº§åˆ¶é€ é˜¶æ®µæ’æ”¾æè¿°"},
    "logistics": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "ç‰©æµè¿è¾“é˜¶æ®µæ’æ”¾æè¿°"},
    "usage": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "äº§å“ä½¿ç”¨é˜¶æ®µæ’æ”¾æè¿°"},
    "recycling": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "å›æ”¶å¤„ç†é˜¶æ®µæ’æ”¾æè¿°"},
    "decomposition": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "è‡ªç„¶é™è§£é˜¶æ®µæ’æ”¾æè¿°"}
  },
  "timeline": {
    "purchase": {"duration": å¤©æ•°, "unit": "å¤©", "description": "é‡‡è´­é˜¶æ®µæ—¶é•¿æè¿°"},
    "produce": {"duration": å¤©æ•°, "unit": "å¤©", "description": "ç”Ÿäº§é˜¶æ®µæ—¶é•¿æè¿°"},
    "use": {"duration": å¤©æ•°, "unit": "å¤©", "description": "ä½¿ç”¨é˜¶æ®µæ—¶é•¿æè¿°"},
    "recycle": {"duration": å¤©æ•°, "unit": "å¤©", "description": "å›æ”¶é˜¶æ®µæ—¶é•¿æè¿°"},
    "decompose": {"duration": å¤©æ•°, "unit": "å¤©", "description": "åˆ†è§£é˜¶æ®µæ—¶é•¿æè¿°"}
  }
}

è¦æ±‚ï¼š
1. æ ¹æ®äº§å“ç±»å‹å’Œç‰¹å¾æä¾›çœŸå®åˆç†çš„æ•°å€¼
2. ç¢³æ’æ”¾å€¼åŸºäºå®é™…è¡Œä¸šæ•°æ®ï¼Œå•ä½ç»Ÿä¸€ä¸ºkg COâ‚‚e
3. æ—¶é—´çº¿ç»Ÿä¸€ç”¨å¤©ä¸ºå•ä½ï¼ˆ1ä¸ªæœˆ=30å¤©ï¼Œ1å¹´=365å¤©ï¼‰
4. è€ƒè™‘äº§å“çš„å…·ä½“ç‰¹ç‚¹å’Œä½¿ç”¨åœºæ™¯
5. æ•°å€¼è¦å…·æœ‰å¯ä¿¡åº¦ï¼Œç¬¦åˆè¡Œä¸šå¸¸è¯†
6. è¿”å›ä¸¥æ ¼JSONæ ¼å¼ï¼Œæ— å¤šä½™æ–‡æœ¬`;

                console.log('ğŸ“¤ å®Œæ•´AIæç¤ºè¯:');
                console.log(prompt);
                console.log('ğŸ“¤ æç¤ºè¯é•¿åº¦:', prompt.length, 'å­—ç¬¦');

                // æ„å»ºè¯·æ±‚å‚æ•°
                const requestBody = {
                    model: 'deepseek-ai/DeepSeek-V3.1',
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    max_tokens: 1000,
                    temperature: 0.3
                };
                
                console.log('ğŸ“¤ APIè¯·æ±‚å‚æ•°:', requestBody);
                console.log('ğŸ“¤ å¼€å§‹å‘é€APIè¯·æ±‚åˆ°:', 'https://api-inference.modelscope.cn/v1/chat/completions');
                console.log('ğŸ“¤ è¯·æ±‚æ—¶é—´:', new Date().toISOString());

                const response = await fetch('/api/ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Client-Request': 'true'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('ğŸ“¥ AI APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                console.log('ğŸ“¥ å“åº”æ—¶é—´:', new Date().toISOString());
                console.log('ğŸ“¥ å“åº”å¤´:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ APIå“åº”å¤±è´¥');
                    console.error('å“åº”çŠ¶æ€:', response.status, response.statusText);
                    console.error('é”™è¯¯å†…å®¹:', errorText);
                    throw new Error(`AIåˆ†æAPIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText} - ${errorText}`);
                }

                console.log('âœ… APIå“åº”æˆåŠŸï¼Œå¼€å§‹è§£ææ•°æ®...');
                const data = await response.json();
                console.log('ğŸ“¥ AI APIå®Œæ•´å“åº”:', data);
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    console.error('âŒ APIå“åº”æ ¼å¼é”™è¯¯:', data);
                    throw new Error('APIå“åº”æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘choicesæˆ–messageå­—æ®µ');
                }
                
                const aiResponse = data.choices[0].message.content;
                console.log('ğŸ“¥ AIè¿”å›å†…å®¹:', aiResponse);
                console.log('ğŸ“¥ AIè¿”å›å†…å®¹é•¿åº¦:', aiResponse.length, 'å­—ç¬¦');
                
                // è§£æAIè¿”å›çš„JSON
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    console.log('ğŸ” æå–çš„JSONå­—ç¬¦ä¸²:', jsonMatch[0]);
                    const analysisData = JSON.parse(jsonMatch[0]);
                    console.log('âœ… è§£æåçš„åˆ†ææ•°æ®:', analysisData);
                    return { success: true, data: analysisData, rawResponse: aiResponse };
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆJSONæ ¼å¼');
                    return { success: false, error: 'æœªæ‰¾åˆ°æœ‰æ•ˆJSONæ ¼å¼', rawResponse: aiResponse };
                }
                
            } catch (error) {
                console.error('%câŒ generateAIAnalysisDataå‡½æ•°å¼‚å¸¸', 'color: red; font-weight: bold;');
                console.error('é”™è¯¯ç±»å‹:', error.constructor.name);
                console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                console.error('å‘ç”Ÿæ—¶é—´:', new Date().toISOString());
                return { success: false, error: error.message, errorType: error.constructor.name };
            }
        }

        // æµ‹è¯•AIåˆ†æåŠŸèƒ½
        async function testAIAnalysis() {
            // ç«‹å³è¾“å‡ºè°ƒè¯•ä¿¡æ¯
            console.clear(); // æ¸…ç©ºæ§åˆ¶å°
            console.log('%cğŸš€ AIåˆ†ææµ‹è¯•è¢«ç‚¹å‡»äº†ï¼', 'color: blue; font-size: 16px; font-weight: bold;');
            console.log('=================== AIåˆ†ææµ‹è¯•å¼€å§‹ ===================');
            console.log('å½“å‰æ—¶é—´:', new Date().toLocaleTimeString());
            
            document.getElementById('aiAnalysisResult').innerHTML = `
                <div class="warning">
                    <h4>ğŸ¤– æ­£åœ¨æµ‹è¯•AIåˆ†æåŠŸèƒ½...</h4>
                    <p>è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†è¾“å…¥è¾“å‡ºä¿¡æ¯</p>
                    <p>â° å¼€å§‹æ—¶é—´: ${new Date().toLocaleTimeString()}</p>
                </div>
            `;

            try {
                console.log('ğŸ“‹ æµ‹è¯•æ•°æ®å‡†å¤‡...');
                console.log('- æ–‡æ¡£æ•°æ®:', MOCK_DOCUMENT_DATA);
                console.log('- è¡¥å……æ•°æ®:', MOCK_SUPPLEMENT_DATA);
                console.log('âœ… æµ‹è¯•æ•°æ®å‡†å¤‡å®Œæˆ');
                console.log('ğŸ¯ å¼€å§‹è°ƒç”¨AI API...');

                const result = await generateAIAnalysisData(
                    MOCK_DOCUMENT_DATA.content,
                    MOCK_SUPPLEMENT_DATA,
                    MOCK_DOCUMENT_DATA.documentType
                );

                if (result.success) {
                    document.getElementById('aiAnalysisResult').innerHTML = `
                        <div class="success">
                            <h4>âœ… AIåˆ†ææµ‹è¯•æˆåŠŸ</h4>
                            <p><strong>åˆ†æç»“æœéªŒè¯:</strong></p>
                            <ul>
                                <li>ç¢³æ’æ”¾æ•°æ®: ${result.data.emissions ? Object.keys(result.data.emissions).length : 0} ä¸ªé˜¶æ®µ</li>
                                <li>æ—¶é—´çº¿æ•°æ®: ${result.data.timeline ? Object.keys(result.data.timeline).length : 0} ä¸ªé˜¶æ®µ</li>
                            </ul>
                            <details>
                                <summary>æŸ¥çœ‹åˆ†æç»“æœJSON</summary>
                                <pre>${JSON.stringify(result.data, null, 2)}</pre>
                            </details>
                            <details>
                                <summary>æŸ¥çœ‹AIåŸå§‹å“åº”</summary>
                                <pre>${result.rawResponse}</pre>
                            </details>
                        </div>
                    `;
                    console.log('âœ… AIåˆ†ææµ‹è¯•æˆåŠŸå®Œæˆ');
                } else {
                    document.getElementById('aiAnalysisResult').innerHTML = `
                        <div class="error">
                            <h4>âŒ AIåˆ†ææµ‹è¯•å¤±è´¥</h4>
                            <p><strong>é”™è¯¯:</strong> ${result.error}</p>
                            ${result.rawResponse ? `
                                <details>
                                    <summary>æŸ¥çœ‹AIåŸå§‹å“åº”</summary>
                                    <pre>${result.rawResponse}</pre>
                                </details>
                            ` : ''}
                        </div>
                    `;
                    console.log('âŒ AIåˆ†ææµ‹è¯•å¤±è´¥:', result.error);
                }

                console.log('=================== AIåˆ†ææµ‹è¯•ç»“æŸ ===================');

            } catch (error) {
                console.error('%câŒ AIåˆ†ææµ‹è¯•å¼‚å¸¸', 'color: red; font-size: 14px; font-weight: bold;');
                console.error('é”™è¯¯è¯¦æƒ…:', error);
                console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                
                document.getElementById('aiAnalysisResult').innerHTML = `
                    <div class="error">
                        <h4>âŒ AIåˆ†ææµ‹è¯•å¼‚å¸¸</h4>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                        <p>â° é”™è¯¯æ—¶é—´: ${new Date().toLocaleTimeString()}</p>
                        <details>
                            <summary>æŸ¥çœ‹é”™è¯¯å †æ ˆ</summary>
                            <pre>${error.stack}</pre>
                        </details>
                    </div>
                `;
                console.log('=================== AIåˆ†ææµ‹è¯•å¼‚å¸¸ç»“æŸ ===================');
            }
        }

        // æµ‹è¯•å®Œæ•´AIåˆ†ææµç¨‹
        async function testFullAIFlow() {
            document.getElementById('fullAIResult').innerHTML = `
                <div class="warning">
                    <h4>ğŸ”„ æ­£åœ¨æµ‹è¯•å®Œæ•´AIåˆ†ææµç¨‹...</h4>
                    <p>åŒ…å«ï¼šæ–‡æ¡£å¤„ç† â†’ AIåˆ†æ â†’ æ•°æ®æ•´åˆ â†’ æ¸²æŸ“å‡†å¤‡</p>
                    <p>è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†è¿‡ç¨‹ä¿¡æ¯</p>
                </div>
            `;

            try {
                console.log('=================== å®Œæ•´AIæµç¨‹æµ‹è¯•å¼€å§‹ ===================');
                
                // Step 1: æ¨¡æ‹Ÿæ–‡æ¡£å¤„ç†
                console.log('ğŸ“‹ Step 1: æ–‡æ¡£å¤„ç†');
                const documentContent = MOCK_DOCUMENT_DATA.content;
                const supplementData = MOCK_SUPPLEMENT_DATA;
                const productType = MOCK_DOCUMENT_DATA.documentType;
                console.log('âœ… æ–‡æ¡£å¤„ç†å®Œæˆ');

                // Step 2: AIåˆ†æ
                console.log('ğŸ¤– Step 2: AIåˆ†æ');
                const aiResult = await generateAIAnalysisData(documentContent, supplementData, productType);
                
                if (!aiResult.success) {
                    throw new Error('AIåˆ†æå¤±è´¥: ' + aiResult.error);
                }
                console.log('âœ… AIåˆ†æå®Œæˆ');

                // Step 3: æ•°æ®æ•´åˆ
                console.log('ğŸ”§ Step 3: æ•°æ®æ•´åˆ');
                const analysisData = {
                    emissions: {},
                    timeline: {},
                    needsAIAnalysis: false,
                    aiGeneratedAt: new Date().toISOString()
                };

                // æ•´åˆç¢³æ’æ”¾æ•°æ®
                if (aiResult.data.emissions) {
                    Object.keys(aiResult.data.emissions).forEach(phase => {
                        const aiValue = aiResult.data.emissions[phase].value;
                        analysisData.emissions[phase] = {
                            value: aiValue,
                            originalValue: aiValue,
                            isAIGenerated: true,
                            description: aiResult.data.emissions[phase].description
                        };
                    });
                }

                // æ•´åˆæ—¶é—´çº¿æ•°æ®
                if (aiResult.data.timeline) {
                    Object.keys(aiResult.data.timeline).forEach(phase => {
                        const aiDuration = aiResult.data.timeline[phase].duration;
                        analysisData.timeline[phase] = {
                            duration: aiDuration,
                            originalDuration: aiDuration,
                            isAIGenerated: true,
                            description: aiResult.data.timeline[phase].description,
                            unit: 'å¤©'
                        };
                    });
                }
                console.log('âœ… æ•°æ®æ•´åˆå®Œæˆ');

                // Step 4: éªŒè¯æ•°æ®å®Œæ•´æ€§
                console.log('ğŸ” Step 4: æ•°æ®éªŒè¯');
                const emissionPhases = ['procurement', 'manufacturing', 'logistics', 'usage', 'recycling', 'decomposition'];
                const timelinePhases = ['purchase', 'produce', 'use', 'recycle', 'decompose'];
                
                const missingEmissions = emissionPhases.filter(phase => !analysisData.emissions[phase]);
                const missingTimeline = timelinePhases.filter(phase => !analysisData.timeline[phase]);
                
                let validationIssues = [];
                if (missingEmissions.length > 0) {
                    validationIssues.push(`ç¼ºå°‘ç¢³æ’æ”¾é˜¶æ®µ: ${missingEmissions.join(', ')}`);
                }
                if (missingTimeline.length > 0) {
                    validationIssues.push(`ç¼ºå°‘æ—¶é—´çº¿é˜¶æ®µ: ${missingTimeline.join(', ')}`);
                }

                console.log('ğŸ¯ éªŒè¯ç»“æœ:');
                console.log('- ç¢³æ’æ”¾é˜¶æ®µ:', Object.keys(analysisData.emissions).length, '/', emissionPhases.length);
                console.log('- æ—¶é—´çº¿é˜¶æ®µ:', Object.keys(analysisData.timeline).length, '/', timelinePhases.length);
                console.log('- éªŒè¯é—®é¢˜:', validationIssues.length === 0 ? 'æ— ' : validationIssues);

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('fullAIResult').innerHTML = `
                    <div class="success">
                        <h4>âœ… å®Œæ•´AIåˆ†ææµç¨‹æµ‹è¯•æˆåŠŸ</h4>
                        <div class="flow-summary">
                            <h5>ğŸ“Š æµç¨‹æ€»ç»“:</h5>
                            <ul>
                                <li>âœ… æ–‡æ¡£å¤„ç†: ${documentContent.length} å­—ç¬¦</li>
                                <li>âœ… AIåˆ†æ: æˆåŠŸç”Ÿæˆåˆ†ææ•°æ®</li>
                                <li>âœ… æ•°æ®æ•´åˆ: ${Object.keys(analysisData.emissions).length} ä¸ªç¢³æ’æ”¾é˜¶æ®µ, ${Object.keys(analysisData.timeline).length} ä¸ªæ—¶é—´çº¿é˜¶æ®µ</li>
                                <li>âœ… æ•°æ®éªŒè¯: ${validationIssues.length === 0 ? 'é€šè¿‡' : 'å‘ç° ' + validationIssues.length + ' ä¸ªé—®é¢˜'}</li>
                            </ul>
                            ${validationIssues.length > 0 ? `
                                <div class="validation-issues">
                                    <h6>âš ï¸ éªŒè¯é—®é¢˜:</h6>
                                    <ul>${validationIssues.map(issue => `<li>${issue}</li>`).join('')}</ul>
                                </div>
                            ` : ''}
                        </div>
                        <details>
                            <summary>æŸ¥çœ‹å®Œæ•´åˆ†ææ•°æ®ç»“æ„</summary>
                            <pre>${JSON.stringify(analysisData, null, 2)}</pre>
                        </details>
                        <div class="ai-generated-badge">
                            <strong>ğŸ¤– æ•°æ®æ¥æº:</strong> 100% AIç”Ÿæˆ (DeepSeek-V3.1)
                        </div>
                    </div>
                `;

                // è‹¥å°šæ— ä»»åŠ¡ï¼ŒåŸºäºåˆ†ææ•°æ®ç”Ÿæˆç®€å•è®¡åˆ’å¹¶æ¸²æŸ“
                try {
                    if (!window.scrumTasks || !Array.isArray(window.scrumTasks?.todo)) {
                        const fallbackPlan = buildScrumPlanFallback({}, analysisData);
                        const buckets = { 'todo': [], 'in-progress': [], 'done': [] };
                        const tasks = Array.isArray(fallbackPlan?.tasks) ? fallbackPlan.tasks : [];
                        const normalizePriority = (p) => (p==='high'||p==='medium'||p==='low') ? p : 'medium';
                        const normalizeStatus = (s) => (s==='todo'||s==='in-progress'||s==='done') ? s : 'todo';
                        tasks.forEach((t, idx) => {
                            const task = {
                                id: `gen-${Date.now()}-${idx}`,
                                title: t.title || `ä»»åŠ¡${idx+1}`,
                                description: t.desc || '',
                                assignee: '',
                                priority: normalizePriority(t.priority),
                                storyPoints: Number.isFinite(t.storyPoints) ? t.storyPoints : 5,
                                startDate: t.startDate || new Date().toISOString().slice(0,10),
                                endDate: t.endDate || new Date(Date.now()+3*86400000).toISOString().slice(0,10),
                                tags: Array.isArray(t.tags) ? t.tags : [],
                                progress: t.status==='in-progress' ? 30 : (t.status==='done'? 100 : undefined)
                            };
                            buckets[normalizeStatus(t.status)].push(task);
                        });
                        window.scrumTasks = Object.assign(buckets, { __auto: true });
                        safeRenderVisuals();
                    }
                } catch(e) { console.warn('ç”Ÿæˆå¯è§†åŒ–è®¡åˆ’å¤±è´¥:', e); }

                console.log('âœ… å®Œæ•´AIæµç¨‹æµ‹è¯•æˆåŠŸå®Œæˆ');
                console.log('=================== å®Œæ•´AIæµç¨‹æµ‹è¯•ç»“æŸ ===================');

            } catch (error) {
                document.getElementById('fullAIResult').innerHTML = `
                    <div class="error">
                        <h4>âŒ å®Œæ•´AIåˆ†ææµç¨‹æµ‹è¯•å¤±è´¥</h4>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
                console.error('âŒ å®Œæ•´AIæµç¨‹æµ‹è¯•å¤±è´¥:', error);
                console.log('=================== å®Œæ•´AIæµç¨‹æµ‹è¯•å¼‚å¸¸ç»“æŸ ===================');
            }
        }

        // ==================== å¯è§†åŒ–æ¸²æŸ“å‡½æ•° ====================
        function safeRenderVisuals() {
            try { renderKanbanBoard(); } catch(e) { console.warn('æ¸²æŸ“Kanbanå¤±è´¥:', e); }
            try { renderGanttChart(); } catch(e) { console.warn('æ¸²æŸ“ç”˜ç‰¹å›¾å¤±è´¥:', e); }
        }

        function getBuckets() {
            const empty = { 'todo': [], 'in-progress': [], 'done': [] };
            if (!window.scrumTasks) return empty;
            return {
                'todo': Array.isArray(window.scrumTasks['todo']) ? window.scrumTasks['todo'] : [],
                'in-progress': Array.isArray(window.scrumTasks['in-progress']) ? window.scrumTasks['in-progress'] : [],
                'done': Array.isArray(window.scrumTasks['done']) ? window.scrumTasks['done'] : []
            };
        }

        function renderKanbanBoard() {
            const board = document.getElementById('kanbanBoard');
            if (!board) return;
            const buckets = getBuckets();
            const statusNames = { 'todo': 'å¾…åŠäº‹é¡¹', 'in-progress': 'è¿›è¡Œä¸­', 'done': 'å·²å®Œæˆ' };
            const colors = { high: '#dc3545', medium: '#ffc107', low: '#28a745' };

            const colHtml = ['todo','in-progress','done'].map(status => {
                const items = buckets[status].map(task => {
                    const progress = Number.isFinite(task.progress) ? Math.max(0, Math.min(100, task.progress)) : null;
                    return `
                        <div class="task-card">
                            <div class="task-header">
                                <span class="task-priority-dot" style="background:${colors[task.priority]||'#adb5bd'}"></span>
                                <span class="task-points">${Number.isFinite(task.storyPoints)?task.storyPoints:5} SP</span>
                            </div>
                            <h5 class="task-title">${escapeHtml(task.title||'æœªå‘½åä»»åŠ¡')}</h5>
                            ${task.description?`<div class="task-desc">${escapeHtml(task.description)}</div>`:''}
                            ${progress!==null?`<div class="task-progress-bar"><div class="task-progress-fill" style="width:${progress}%"></div></div>`:''}
                            <div class="task-meta">
                                <span>${escapeHtml(task.assignee||'æœªåˆ†é…')}</span>
                                <span>${escapeHtml(task.startDate||'')}${task.endDate?` - ${escapeHtml(task.endDate)}`:''}</span>
                            </div>
                            ${Array.isArray(task.tags)&&task.tags.length?`<div class="task-tags">${task.tags.map(t=>`<span class=\"task-tag\">${escapeHtml(String(t))}</span>`).join('')}</div>`:''}
                        </div>`;
                }).join('');
                return `
                    <div class="kanban-column">
                        <div class="column-header">
                            <h4>${statusNames[status]}</h4>
                            <span class="count-badge">${buckets[status].length}</span>
                        </div>
                        <div class="task-list">${items || '<div class="empty-note">æš‚æ— ä»»åŠ¡</div>'}</div>
                    </div>`;
            }).join('');

            board.innerHTML = colHtml;
        }

        function parseISO(d){ try { return new Date(d); } catch(e){ return null; } }

        function collectAllTasks() {
            const b = getBuckets();
            return ([]).concat(b['todo'], b['in-progress'], b['done']).filter(Boolean);
        }

        function getMinMaxDates(tasks){
            const starts = tasks.map(t=>parseISO(t.startDate)).filter(x=>x&&isFinite(x));
            const ends = tasks.map(t=>parseISO(t.endDate)).filter(x=>x&&isFinite(x));
            if (!starts.length || !ends.length) return null;
            const min = new Date(Math.min(...starts));
            const max = new Date(Math.max(...ends));
            // ä¿è¯è‡³å°‘1å¤©èŒƒå›´
            if (min.getTime()===max.getTime()) { max.setDate(max.getDate()+1); }
            return {min,max};
        }

        function eachDay(from,to){ const days=[]; const d=new Date(from); while(d<=to){ days.push(new Date(d)); d.setDate(d.getDate()+1);} return days; }
        function fmtShort(d){ const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${m}/${dd}`; }

        function renderGanttChart() {
            const wrap = document.getElementById('ganttChart');
            if (!wrap) return;
            const all = collectAllTasks();
            if (!all.length) { wrap.innerHTML = '<div class="empty-note">æš‚æ— ä»»åŠ¡æ•°æ®ï¼Œè¯·å…ˆè¿è¡Œä¸Šæ–¹æµ‹è¯•ç”Ÿæˆä»»åŠ¡</div>'; return; }
            const range = getMinMaxDates(all);
            if (!range) { wrap.innerHTML = '<div class="empty-note">ä»»åŠ¡ç¼ºå°‘æœ‰æ•ˆæ—¥æœŸï¼Œæ— æ³•æ¸²æŸ“ç”˜ç‰¹å›¾</div>'; return; }
            const days = eachDay(range.min, range.max);

            const header = `
                <div class="gantt-header-row">
                    <div class="gantt-task-col-title">ä»»åŠ¡ä¿¡æ¯</div>
                    <div class="gantt-dates">
                        ${days.map(d=>`<div class="gantt-date" title="${d.toISOString().slice(0,10)}">${fmtShort(d)}</div>`).join('')}
                    </div>
                </div>`;

            const totalDays = Math.max(1, Math.round((range.max - range.min)/(24*3600*1000))+1);

            const rows = all.map(task => {
                const s = parseISO(task.startDate); const e = parseISO(task.endDate);
                const startOffset = Math.max(0, Math.floor((s - range.min)/(24*3600*1000)));
                const dur = Math.max(1, Math.floor((e - s)/(24*3600*1000))+1);
                const leftPct = (startOffset/totalDays)*100;
                const widthPct = (dur/totalDays)*100;
                let status = 'todo';
                if ((window.scrumTasks?.['in-progress']||[]).some(t=>t.id===task.id)) status='in-progress';
                if ((window.scrumTasks?.['done']||[]).some(t=>t.id===task.id)) status='done';
                return `
                    <div class="gantt-row">
                        <div class="gantt-task-info">
                            <div class="gantt-task-title" title="${escapeHtml(task.title||'')}">${escapeHtml(task.title||'')}</div>
                            <div class="gantt-task-meta">${escapeHtml(task.startDate||'')} - ${escapeHtml(task.endDate||'')} Â· ${Number.isFinite(task.storyPoints)?task.storyPoints:5} SP</div>
                        </div>
                        <div class="gantt-timeline">
                            <div class="gantt-bar ${status}" style="left:${leftPct}%; width:${widthPct}%;" title="${escapeHtml(task.title||'')}">${escapeHtml(task.title||'')}</div>
                        </div>
                    </div>`;
            }).join('');

            wrap.innerHTML = header + `<div class="gantt-rows">${rows}</div>`;
        }

        function escapeHtml(s){
            return String(s).replace(/[&<>"]+/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
        }

        // é¡µé¢åŠ è½½æ—¶éªŒè¯å‡½æ•°
        document.addEventListener('DOMContentLoaded', function() {
            console.log('%cğŸ”§ è°ƒè¯•å·¥å…·åŠ è½½å®Œæˆ', 'color: purple; font-size: 14px; font-weight: bold;');
            console.log('éªŒè¯å…³é”®å‡½æ•°æ˜¯å¦å®šä¹‰:');
            console.log('- testAIAnalysis:', typeof testAIAnalysis);
            console.log('- generateAIAnalysisData:', typeof generateAIAnalysisData);
            console.log('- getDocumentTypeName:', typeof getDocumentTypeName);
            console.log('- testFullAIFlow:', typeof testFullAIFlow);
            console.log('ğŸ“‹ æ¨¡æ‹Ÿæ•°æ®éªŒè¯:');
            console.log('- MOCK_DOCUMENT_DATA:', MOCK_DOCUMENT_DATA);
            console.log('- MOCK_SUPPLEMENT_DATA:', MOCK_SUPPLEMENT_DATA);
            
            // æµ‹è¯•æŒ‰é’®ç»‘å®š
            const aiButton = document.querySelector('button[onclick="testAIAnalysis()"]');
            if (aiButton) {
                console.log('âœ… AIåˆ†ææŒ‰é’®æ‰¾åˆ°å¹¶ç»‘å®šæ­£ç¡®');
            } else {
                console.error('âŒ AIåˆ†ææŒ‰é’®æœªæ‰¾åˆ°æˆ–ç»‘å®šé”™è¯¯');
            }
            
            console.log('ğŸ¯ è°ƒè¯•å·¥å…·å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
