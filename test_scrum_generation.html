<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrumæ‰§è¡Œå›¾ç”ŸæˆåŠŸèƒ½æµ‹è¯•</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #007bff;
        }
        
        .test-section h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.success:hover {
            background: #218838;
        }
        
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn.warning:hover {
            background: #e0a800;
        }
        
        .output-box {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-running {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .test-card:hover {
            border-color: #007bff;
            box-shadow: 0 5px 15px rgba(0,123,255,0.1);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .kanban-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .kanban-column {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e9ecef;
        }
        
        .kanban-column h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .task-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            border-left: 3px solid #007bff;
        }
        
        .gantt-preview {
            margin-top: 20px;
        }
        
        .gantt-timeline {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
        }
        
        .gantt-bar {
            height: 20px;
            background: #007bff;
            border-radius: 4px;
            margin: 5px 0;
            padding: 2px 8px;
            color: white;
            font-size: 11px;
            display: flex;
            align-items: center;
        }
        
        kbd {
            background: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 12px;
            color: #495057;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tasks"></i> Scrumæ‰§è¡Œå›¾ç”ŸæˆåŠŸèƒ½æµ‹è¯•</h1>
            <p>ğŸ¤– çœŸå®AIé›†æˆæµ‹è¯•ï¼šæ–‡æ¡£å¤„ç† â†’ AIè¡¥å…¨ â†’ AI Leanå»ºè®® â†’ AI Scrumæ‰§è¡Œå›¾</p>
            <p style="margin-top: 10px; font-size: 14px; opacity: 0.9;">
                âœ… å®Œå…¨å¯¹æ¥çœŸå®AI API &nbsp;|&nbsp; âœ… ä¸ä¸»ç³»ç»ŸåŠŸèƒ½ä¸€è‡´ &nbsp;|&nbsp; âœ… åŒ…å«å®¹é”™å›é€€æœºåˆ¶
            </p>
            <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; margin-top: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #1976d2;">
                    <i class="fas fa-info-circle"></i> æ§åˆ¶å°è°ƒè¯•æ¨¡å¼
                </h4>
                <p style="margin: 0; font-size: 14px; color: #424242;">
                    ğŸ“º æŒ‰ <kbd>F12</kbd> æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ‰€æœ‰AIè°ƒç”¨çš„è¯¦ç»†è¾“å…¥è¾“å‡ºä¿¡æ¯ï¼š
                    <br>â€¢ AIæç¤ºè¯å†…å®¹ â€¢ APIè¯·æ±‚å‚æ•° â€¢ AIè¿”å›ç»“æœ â€¢ æ•°æ®å¤„ç†è¿‡ç¨‹
                </p>
            </div>
        </div>
        
        <div class="content">
            <!-- æ€»ä½“æ§åˆ¶é¢æ¿ -->
            <div class="test-section">
                <h2><i class="fas fa-play-circle"></i> æµ‹è¯•æ§åˆ¶é¢æ¿</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                    <button class="btn success" onclick="runFullTest()">
                        <i class="fas fa-rocket"></i> è¿è¡Œå®Œæ•´æµ‹è¯•
                    </button>
                    <button class="btn" onclick="runStepByStep()">
                        <i class="fas fa-step-forward"></i> åˆ†æ­¥æ‰§è¡Œ
                    </button>
                    <button class="btn warning" onclick="resetTest()">
                        <i class="fas fa-undo"></i> é‡ç½®æµ‹è¯•
                    </button>
                    <span id="globalStatus" class="status-indicator status-pending">
                        <i class="fas fa-clock"></i> å¾…å¼€å§‹
                    </span>
                </div>
                <div class="progress-bar">
                    <div id="globalProgress" class="progress-fill"></div>
                </div>
            </div>
            
            <!-- æµ‹è¯•æ­¥éª¤ -->
            <div class="test-grid">
                <!-- æ­¥éª¤1: æ–‡æ¡£å¤„ç†å’ŒAIè¡¥å…¨ -->
                <div class="test-card">
                    <h3><i class="fas fa-file-upload"></i> æ­¥éª¤1: æ–‡æ¡£å¤„ç†</h3>
                    <p>ğŸ¤– EcoLoopæ–‡æ¡£ä¸Šä¼  + çœŸå®AIè¡¥å…¨ï¼ˆè°ƒç”¨DeepSeek-V3.1ï¼‰</p>
                    <button class="btn" onclick="testDocumentProcessing()">
                        <i class="fas fa-upload"></i> æµ‹è¯•æ–‡æ¡£å¤„ç†
                    </button>
                    <span id="step1Status" class="status-indicator status-pending">
                        <i class="fas fa-clock"></i> å¾…å¼€å§‹
                    </span>
                    <div id="step1Output" class="output-box" style="display: none;"></div>
                </div>
                
                <!-- æ­¥éª¤2: æ•°æ®åˆ†æ -->
                <div class="test-card">
                    <h3><i class="fas fa-chart-line"></i> æ­¥éª¤2: æ•°æ®åˆ†æ</h3>
                    <p>ğŸ“Š ç”Ÿæˆç¢³æ’æ”¾å’Œæ—¶é—´çº¿åˆ†ææ•°æ®ï¼ˆåŸºç¡€æ•°æ®å‡†å¤‡ï¼‰</p>
                    <button class="btn" onclick="testDataAnalysis()">
                        <i class="fas fa-analytics"></i> æµ‹è¯•æ•°æ®åˆ†æ
                    </button>
                    <span id="step2Status" class="status-indicator status-pending">
                        <i class="fas fa-clock"></i> å¾…å¼€å§‹
                    </span>
                    <div id="step2Output" class="output-box" style="display: none;"></div>
                </div>
                
                <!-- æ­¥éª¤3: Leanå»ºè®®ç”Ÿæˆ -->
                <div class="test-card">
                    <h3><i class="fas fa-lightbulb"></i> æ­¥éª¤3: Leanå»ºè®®</h3>
                    <p>ğŸ¤– çœŸå®AIç”Ÿæˆ3ä¸ªé¢†åŸŸä¼˜åŒ–å»ºè®®ï¼ˆè°ƒç”¨DeepSeek-V3.1ï¼‰</p>
                    <button class="btn" onclick="testLeanSuggestions()">
                        <i class="fas fa-brain"></i> æµ‹è¯•Leanå»ºè®®
                    </button>
                    <span id="step3Status" class="status-indicator status-pending">
                        <i class="fas fa-clock"></i> å¾…å¼€å§‹
                    </span>
                    <div id="step3Output" class="output-box" style="display: none;"></div>
                </div>
                
                <!-- æ­¥éª¤4: Scrumæ‰§è¡Œå›¾ç”Ÿæˆ -->
                <div class="test-card">
                    <h3><i class="fas fa-tasks"></i> æ­¥éª¤4: Scrumæ‰§è¡Œå›¾</h3>
                    <p>ğŸ¤– çœŸå®AIç”ŸæˆScrumä»»åŠ¡å’Œç”˜ç‰¹å›¾ï¼ˆè°ƒç”¨DeepSeek-V3.1ï¼‰</p>
                    <button class="btn" onclick="testScrumGeneration()">
                        <i class="fas fa-project-diagram"></i> æµ‹è¯•Scrumç”Ÿæˆ
                    </button>
                    <span id="step4Status" class="status-indicator status-pending">
                        <i class="fas fa-clock"></i> å¾…å¼€å§‹
                    </span>
                    <div id="step4Output" class="output-box" style="display: none;"></div>
                </div>
            </div>
            
            <!-- ç»“æœå±•ç¤º -->
            <div class="test-section">
                <h2><i class="fas fa-chart-gantt"></i> ç”Ÿæˆç»“æœé¢„è§ˆ</h2>
                <div id="resultPreview" style="display: none;">
                    <h3>Kanbançœ‹æ¿é¢„è§ˆ</h3>
                    <div id="kanbanPreview" class="kanban-preview"></div>
                    
                    <h3>ç”˜ç‰¹å›¾é¢„è§ˆ</h3>
                    <div id="ganttPreview" class="gantt-preview"></div>
                </div>
                <div id="noResults" style="text-align: center; color: #6c757d; padding: 40px;">
                    <i class="fas fa-info-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p>è¿è¡Œæµ‹è¯•åæŸ¥çœ‹ç»“æœ</p>
                </div>
            </div>
            
            <!-- AIæç¤ºè¯é¢„è§ˆ -->
            <div class="test-section">
                <h2><i class="fas fa-robot"></i> AIæç¤ºè¯é¢„è§ˆ</h2>
                <button class="btn" onclick="showAIPrompt()">
                    <i class="fas fa-eye"></i> æŸ¥çœ‹æœ€ç»ˆæç¤ºè¯
                </button>
                <div id="aiPromptOutput" class="output-box" style="display: none;"></div>
            </div>
            
            <!-- æµ‹è¯•æ—¥å¿— -->
            <div class="test-section">
                <h2><i class="fas fa-list"></i> æµ‹è¯•æ—¥å¿—</h2>
                <button class="btn" onclick="clearLog()">
                    <i class="fas fa-trash"></i> æ¸…ç©ºæ—¥å¿—
                </button>
                <div id="testLog" class="output-box">
                    === Scrumæ‰§è¡Œå›¾ç”ŸæˆåŠŸèƒ½æµ‹è¯•æ—¥å¿— ===
                    ç­‰å¾…æµ‹è¯•å¼€å§‹...
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€æµ‹è¯•çŠ¶æ€
        let testState = {
            currentStep: 0,
            totalSteps: 4,
            documentContent: null,
            supplementData: null,
            analysisData: null,
            leanSuggestions: null,
            acceptedSuggestions: null,
            scrumTasks: null,
            testStartTime: null
        };

        // æ¨¡æ‹Ÿçš„EcoLoopç”µåŠ¨æ±½è½¦è®¾è®¡æ–‡æ¡£å†…å®¹
        const MOCK_ECOLOOP_DOCUMENT = {
            title: "EcoLoopç”µåŠ¨æ±½è½¦è®¾è®¡è§„èŒƒ",
            content: `EcoLoopç”µåŠ¨æ±½è½¦è®¾è®¡è§„èŒƒ

äº§å“æ¦‚è¿°ï¼š
EcoLoopæ˜¯ä¸€æ¬¾é¢å‘åŸå¸‚é€šå‹¤çš„çº¯ç”µåŠ¨æ±½è½¦ï¼Œé‡‡ç”¨è½»é‡åŒ–è®¾è®¡ç†å¿µï¼Œæ­è½½å…ˆè¿›çš„ç”µæ± ç®¡ç†ç³»ç»Ÿå’Œæ™ºèƒ½é©¾é©¶è¾…åŠ©åŠŸèƒ½ã€‚

æŠ€æœ¯è§„æ ¼ï¼š
- ç”µæ± å®¹é‡ï¼š60kWhä¸‰å…ƒé”‚ç”µæ± ç»„
- ç»­èˆªé‡Œç¨‹ï¼šNEDCå·¥å†µä¸‹450km
- ç”µæœºåŠŸç‡ï¼šå‰ç½®å•ç”µæœºï¼Œæœ€å¤§åŠŸç‡150kW
- è½¦èº«ææ–™ï¼šé“åˆé‡‘è½¦èº«æ¡†æ¶ï¼Œç¢³çº¤ç»´è¦†ç›–ä»¶
- å……ç”µè§„æ ¼ï¼šæ”¯æŒå¿«å……ï¼ˆ30åˆ†é’Ÿ80%ï¼‰å’Œæ…¢å……

è®¾è®¡è¦æ±‚ï¼š
1. è½»é‡åŒ–è®¾è®¡ï¼šæ•´è½¦é‡é‡æ§åˆ¶åœ¨1.5å¨ä»¥å†…
2. å¯æŒç»­ææ–™ï¼šä¼˜å…ˆä½¿ç”¨å¯å›æ”¶å’Œç”Ÿç‰©åŸºææ–™
3. åˆ¶é€ å·¥è‰ºï¼šé‡‡ç”¨ç²¾ç›Šç”Ÿäº§æµç¨‹ï¼Œå‡å°‘èƒ½è€—å’ŒåºŸæ–™
4. ä¾›åº”é“¾ï¼šå»ºç«‹æœ¬åœ°åŒ–ä¾›åº”å•†ç½‘ç»œï¼Œå‡å°‘è¿è¾“æ’æ”¾
5. åŒ…è£…æ–¹æ¡ˆï¼šä½¿ç”¨ç¯ä¿åŒ…è£…ææ–™ï¼Œå»ºç«‹åŒ…è£…å›æ”¶ä½“ç³»

ç¯ä¿ç›®æ ‡ï¼š
- æ•´è½¦ç”Ÿå‘½å‘¨æœŸç¢³æ’æ”¾ä½äºä¼ ç»Ÿç‡ƒæ²¹è½¦50%
- åˆ¶é€ é˜¶æ®µèƒ½è€—æ¯”è¡Œä¸šå¹³å‡æ°´å¹³é™ä½30%
- ææ–™å›æ”¶ç‡è¾¾åˆ°95%ä»¥ä¸Š
- åŒ…è£…ææ–™100%å¯å›æ”¶æˆ–å¯é™è§£

åˆ¶é€ æµç¨‹ï¼š
é‡‡è´­é˜¶æ®µ â†’ é›¶éƒ¨ä»¶åˆ¶é€  â†’ æ€»è£…ç”Ÿäº§ â†’ è´¨é‡æ£€æµ‹ â†’ åŒ…è£…è¿è¾“ â†’ äº¤ä»˜ä½¿ç”¨ â†’ ç»´æŠ¤ä¿å…» â†’ å›æ”¶å¤„ç†

åˆ›æ–°ç‰¹è‰²ï¼š
- æ¨¡å—åŒ–ç”µæ± è®¾è®¡ï¼Œä¾¿äºç»´æŠ¤å’Œå‡çº§
- æ™ºèƒ½èƒ½è€—ç®¡ç†ç³»ç»Ÿï¼Œå®æ—¶ä¼˜åŒ–èƒ½æ•ˆ
- V2GæŠ€æœ¯ï¼Œæ”¯æŒè½¦è¾†å‘ç”µç½‘åå‘é€ç”µ
- OTAè¿œç¨‹å‡çº§ï¼ŒæŒç»­ä¼˜åŒ–é©¾é©¶ä½“éªŒ`,
            documentType: 'automotive',
            uploadDate: new Date().toISOString()
        };

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.textContent += `\\n[${timestamp}] ${icon} ${message}`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(stepId, status, text) {
            const element = document.getElementById(stepId);
            element.className = `status-indicator status-${status}`;
            
            const icons = {
                pending: 'fas fa-clock',
                running: 'fas fa-spinner fa-spin',
                success: 'fas fa-check',
                error: 'fas fa-times'
            };
            
            element.innerHTML = `<i class="${icons[status]}"></i> ${text}`;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percentage) {
            document.getElementById('globalProgress').style.width = percentage + '%';
        }

        // æ˜¾ç¤ºè¾“å‡º
        function showOutput(stepId, content) {
            const outputElement = document.getElementById(stepId);
            outputElement.style.display = 'block';
            outputElement.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
        }

        // æ­¥éª¤1: æ–‡æ¡£å¤„ç†å’ŒAIè¡¥å…¨
        async function testDocumentProcessing() {
            log('å¼€å§‹æ­¥éª¤1: æ–‡æ¡£å¤„ç†å’ŒAIè¡¥å…¨');
            updateStatus('step1Status', 'running', 'å¤„ç†ä¸­...');
            
            try {
                // æ¨¡æ‹Ÿæ–‡æ¡£ä¸Šä¼ 
                await sleep(1000);
                log('âœ“ ä¸Šä¼ EcoLoopè®¾è®¡æ–‡æ¡£');
                testState.documentContent = MOCK_ECOLOOP_DOCUMENT;
                
                // çœŸå®AIè¡¥å…¨è°ƒç”¨
                log('ğŸ¤– è°ƒç”¨AIè¿›è¡Œè¡¥å……ä¿¡æ¯ç”Ÿæˆ...');
                testState.supplementData = await callAIForSupplement();
                
                log('âœ“ AIè¡¥å…¨å®Œæˆï¼Œç”Ÿæˆ5ä¸ªå…³é”®å­—æ®µ');
                updateStatus('step1Status', 'success', 'å®Œæˆ');
                showOutput('step1Output', {
                    documentTitle: testState.documentContent.title,
                    contentLength: testState.documentContent.content.length,
                    supplementData: testState.supplementData
                });
                
                return true;
            } catch (error) {
                log(`âŒ æ­¥éª¤1å¤±è´¥: ${error.message}`, 'error');
                updateStatus('step1Status', 'error', 'å¤±è´¥');
                return false;
            }
        }

        // AIè¡¥å…¨è°ƒç”¨å‡½æ•°
        async function callAIForSupplement() {
            const documentContent = testState.documentContent.content;
            const documentType = testState.documentContent.documentType;
            
            const prompt = `ä½œä¸ºäº§å“è®¾è®¡å’Œåˆ¶é€ ä¸“å®¶ï¼Œè¯·æ ¹æ®ä»¥ä¸‹äº§å“è®¾è®¡æ–‡æ¡£ï¼Œè¡¥å…¨ç¼ºå¤±çš„å…³é”®ä¿¡æ¯ã€‚

ã€äº§å“æ–‡æ¡£ã€‘ï¼š
${documentContent.substring(0, 1000)}...

ã€äº§å“ç±»å‹ã€‘ï¼š${documentType}

è¯·ä¸ºä»¥ä¸‹5ä¸ªå…³é”®å­—æ®µç”Ÿæˆå…·ä½“ã€å‡†ç¡®çš„ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰ï¼š
{
  "ä¾›åº”å•†åœ°ç†ä½ç½®ä¿¡æ¯": "å…·ä½“çš„ä¾›åº”å•†åœ°ç†ä½ç½®å’Œé€‰æ‹©ç†ç”±",
  "åŸææ–™å…·ä½“è§„æ ¼å’Œæ¥æº": "è¯¦ç»†çš„åŸææ–™è§„æ ¼å’Œä¾›åº”å•†ä¿¡æ¯",
  "ç”Ÿäº§å·¥è‰ºè¯¦ç»†æµç¨‹": "å®Œæ•´çš„ç”Ÿäº§å·¥è‰ºæµç¨‹æ­¥éª¤",
  "ç‰©æµè¿è¾“æ–¹å¼å’Œè·¯å¾„": "å…·ä½“çš„ç‰©æµè¿è¾“æ–¹æ¡ˆå’Œè·¯å¾„",
  "äº§å“ä½¿ç”¨åœºæ™¯å’Œå‘¨æœŸ": "è¯¦ç»†çš„ä½¿ç”¨åœºæ™¯æè¿°å’Œç”Ÿå‘½å‘¨æœŸ"
}

è¦æ±‚ï¼š
1) åŸºäºæ–‡æ¡£å†…å®¹ç”ŸæˆçœŸå®å¯ä¿¡çš„ä¿¡æ¯
2) è€ƒè™‘${documentType}è¡Œä¸šç‰¹ç‚¹
3) è¿”å›ä¸¥æ ¼çš„JSONæ ¼å¼
4) ä¿¡æ¯è¦å…·ä½“ä¸”å¯æ‰§è¡Œ`;

            try {
                // ğŸ“¤ æ‰“å°AIè¾“å…¥ä¿¡æ¯
                console.log('=================== AIè¡¥å…¨è°ƒç”¨ ===================');
                console.log('ğŸ”¹ APIç«¯ç‚¹:', 'https://api-inference.modelscope.cn/v1/chat/completions');
                console.log('ğŸ”¹ æ¨¡å‹:', 'deepseek-ai/DeepSeek-V3.1');
                console.log('ğŸ”¹ æç¤ºè¯é•¿åº¦:', prompt.length, 'å­—ç¬¦');
                console.log('ğŸ“¤ å®Œæ•´æç¤ºè¯:');
                console.log(prompt);
                console.log('ğŸ“¤ è¯·æ±‚å‚æ•°:', {
                    model: 'deepseek-ai/DeepSeek-V3.1',
                    max_tokens: 800,
                    temperature: 0.7
                });
                
                const response = await fetch('/api/ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Client-Request': 'true'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-ai/DeepSeek-V3.1',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 800,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    console.log('âŒ AI APIå“åº”é”™è¯¯:', response.status, response.statusText);
                    throw new Error('AI APIè°ƒç”¨å¤±è´¥');
                }

                const data = await response.json();
                console.log('ğŸ“¥ AI APIå®Œæ•´å“åº”:', data);
                
                const content = data.choices[0].message.content;
                console.log('ğŸ“¥ AIè¿”å›å†…å®¹:', content);
                
                // æå–JSON
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsedResult = JSON.parse(jsonMatch[0]);
                    console.log('âœ… è§£æåçš„ç»“æœ:', parsedResult);
                    console.log('=================== AIè¡¥å…¨å®Œæˆ ===================\n');
                    return parsedResult;
                } else {
                    console.log('âŒ æœªæ‰¾åˆ°JSONæ ¼å¼å†…å®¹');
                    throw new Error('AIè¿”å›æ ¼å¼é”™è¯¯');
                }
            } catch (error) {
                log(`âš ï¸ AIè¡¥å…¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®: ${error.message}`, 'warning');
                // å¤‡ç”¨æ•°æ®
                return {
                    "ä¾›åº”å•†åœ°ç†ä½ç½®ä¿¡æ¯": "æ±Ÿè‹è‹å·ï¼ˆåŸºäºæ±½è½¦åˆ¶é€ äº§ä¸šé›†ç¾¤åˆ†æï¼‰",
                    "åŸææ–™å…·ä½“è§„æ ¼å’Œæ¥æº": "é’¢æ-å®é’¢é›†å›¢ï¼Œæ©¡èƒ¶-ç±³å…¶æ—ï¼Œç”µæ± -æ¯”äºšè¿ª",
                    "ç”Ÿäº§å·¥è‰ºè¯¦ç»†æµç¨‹": "å†²å‹æˆå‹â†’ç„Šæ¥è£…é…â†’æ¶‚è£…å¤„ç†â†’æ€»è£…è°ƒè¯•â†’è·¯è¯•æ£€éªŒ",
                    "ç‰©æµè¿è¾“æ–¹å¼å’Œè·¯å¾„": "å¤šå¼è”è¿ï¼Œæµ·è¿+é™†è¿ç»“åˆï¼Œæˆæœ¬ä¼˜åŒ–12%",
                    "äº§å“ä½¿ç”¨åœºæ™¯å’Œå‘¨æœŸ": "äº¤é€šå·¥å…·ï¼Œä½¿ç”¨å¯¿å‘½10-15å¹´"
                };
            }
        }

        // [MODIFIED] æ–°å¢ï¼šAIæ•°æ®åˆ†æè°ƒç”¨å‡½æ•°
        // Impact: ä¸ºâ€œæ­¥éª¤2: æ•°æ®åˆ†æâ€æ¥å…¥çœŸå®AIæ¥å£ï¼Œç‚¹å‡»æŒ‰é’®å°†å‘èµ·APIè¯·æ±‚å¹¶åœ¨æ§åˆ¶å°å®Œæ•´è¾“å‡ºè¯·æ±‚/å“åº”ï¼Œç”Ÿæˆç¢³æ’æ”¾ä¸æ—¶é—´çº¿åŸºç¡€æ•°æ®ã€‚
        // Backward Compatibility: å¦‚æœAIè°ƒç”¨å¤±è´¥æˆ–è¿”å›æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå°†è‡ªåŠ¨å›é€€åˆ°åŸæœ‰çš„æœ¬åœ°åŸºç¡€æ•°æ®ç”Ÿæˆé€»è¾‘ï¼Œä¿è¯åŠŸèƒ½å¯ç”¨ã€‚
        async function callAIForDataAnalysis() {
            const documentContent = testState.documentContent?.content || '';
            const supplementData = testState.supplementData || {};
            const productTypeName = 'æ±½è½¦åˆ¶é€ ';
            
            const prompt = `ä½œä¸ºç¢³æ’æ”¾ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸè¯„ä¼°ä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹äº§å“çš„ç¢³æ’æ”¾å’Œæ—¶é—´çº¿æ•°æ®ã€‚\n\nã€äº§å“ä¿¡æ¯ã€‘\näº§å“ç±»å‹ï¼š${productTypeName}\næ–‡æ¡£å†…å®¹ï¼š${documentContent.substring(0, 1500)}\nè¡¥å……ä¿¡æ¯ï¼š${Object.entries(supplementData).map(([key, value]) => `${key}: ${value}`).join(', ')}\n\nè¯·ä¸ºè¯¥äº§å“ç”ŸæˆçœŸå®å¯ä¿¡çš„ç¢³æ’æ”¾å’Œæ—¶é—´çº¿åˆ†ææ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰ï¼š\n\n{\n  "emissions": {\n    "procurement": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "åŸæ–™é‡‡è´­é˜¶æ®µæ’æ”¾æè¿°"},\n    "manufacturing": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "ç”Ÿäº§åˆ¶é€ é˜¶æ®µæ’æ”¾æè¿°"},\n    "logistics": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "ç‰©æµè¿è¾“é˜¶æ®µæ’æ”¾æè¿°"},\n    "usage": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "äº§å“ä½¿ç”¨é˜¶æ®µæ’æ”¾æè¿°"},\n    "recycling": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "å›æ”¶å¤„ç†é˜¶æ®µæ’æ”¾æè¿°"},\n    "decomposition": {"value": æ•°å€¼, "unit": "kg COâ‚‚e", "description": "è‡ªç„¶é™è§£é˜¶æ®µæ’æ”¾æè¿°"}\n  },\n  "timeline": {\n    "purchase": {"duration": å¤©æ•°, "unit": "å¤©", "description": "é‡‡è´­é˜¶æ®µæ—¶é•¿æè¿°"},\n    "produce": {"duration": å¤©æ•°, "unit": "å¤©", "description": "ç”Ÿäº§é˜¶æ®µæ—¶é•¿æè¿°"},\n    "use": {"duration": å¤©æ•°, "unit": "å¤©", "description": "ä½¿ç”¨é˜¶æ®µæ—¶é•¿æè¿°"},\n    "recycle": {"duration": å¤©æ•°, "unit": "å¤©", "description": "å›æ”¶é˜¶æ®µæ—¶é•¿æè¿°"},\n    "decompose": {"duration": å¤©æ•°, "unit": "å¤©", "description": "åˆ†è§£é˜¶æ®µæ—¶é•¿æè¿°"}\n  }\n}\n\nè¦æ±‚ï¼š\n1. æ ¹æ®äº§å“ç±»å‹å’Œç‰¹å¾æä¾›çœŸå®åˆç†çš„æ•°å€¼\n2. ç¢³æ’æ”¾å€¼åŸºäºå®é™…è¡Œä¸šæ•°æ®ï¼Œå•ä½ç»Ÿä¸€ä¸ºkg COâ‚‚e\n3. æ—¶é—´çº¿ç»Ÿä¸€ç”¨å¤©ä¸ºå•ä½ï¼ˆ1ä¸ªæœˆ=30å¤©ï¼Œ1å¹´=365å¤©ï¼‰\n4. è€ƒè™‘äº§å“çš„å…·ä½“ç‰¹ç‚¹å’Œä½¿ç”¨åœºæ™¯\n5. æ•°å€¼è¦å…·æœ‰å¯ä¿¡åº¦ï¼Œç¬¦åˆè¡Œä¸šå¸¸è¯†\n6. è¿”å›ä¸¥æ ¼JSONæ ¼å¼ï¼Œæ— å¤šä½™æ–‡æœ¬`;
            
            console.log('=================== AIåŸºç¡€æ•°æ®åˆ†æè°ƒç”¨ ===================');
            console.log('ğŸ”¹ APIç«¯ç‚¹:', 'https://api-inference.modelscope.cn/v1/chat/completions');
            console.log('ğŸ”¹ æ¨¡å‹:', 'deepseek-ai/DeepSeek-V3.1');
            console.log('ğŸ“¤ æç¤ºè¯é•¿åº¦:', prompt.length, 'å­—ç¬¦');
            console.log('ğŸ“¤ å®Œæ•´æç¤ºè¯:');
            console.log(prompt);
            const requestBody = {
                model: 'deepseek-ai/DeepSeek-V3.1',
                messages: [{ role: 'user', content: prompt }],
                max_tokens: 1000,
                temperature: 0.3
            };
            console.log('ğŸ“¤ è¯·æ±‚å‚æ•°:', requestBody);
            
            const response = await fetch('/api/ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Client-Request': 'true'
                },
                body: JSON.stringify(requestBody)
            });
            console.log('ğŸ“¥ AI APIå“åº”çŠ¶æ€:', response.status, response.statusText);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.log('âŒ AI APIå“åº”é”™è¯¯:', response.status, response.statusText, '-', errorText);
                throw new Error(`AI APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('ğŸ“¥ AI APIå®Œæ•´å“åº”:', data);
            const aiContent = data?.choices?.[0]?.message?.content || '';
            console.log('ğŸ“¥ AIè¿”å›å†…å®¹:', aiContent);
            
            const jsonMatch = aiContent.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                console.log('âŒ æœªæ‰¾åˆ°æœ‰æ•ˆJSONæ ¼å¼');
                throw new Error('AIè¿”å›æ ¼å¼é”™è¯¯');
            }
            console.log('ğŸ” æå–çš„JSONå­—ç¬¦ä¸²:', jsonMatch[0]);
            const parsed = JSON.parse(jsonMatch[0]);
            console.log('âœ… è§£æåçš„åˆ†ææ•°æ®:', parsed);
            
            // ç»Ÿä¸€è½¬æ¢ä¸ºç³»ç»Ÿå†…éƒ¨æ•°æ®ç»“æ„
            const emissionsOut = {};
            const timelineOut = {};
            const emissionKeys = ['procurement','manufacturing','logistics','usage','recycling','decomposition'];
            const timelineKeys = ['purchase','produce','use','recycle','decompose'];
            
            emissionKeys.forEach(k => {
                const item = parsed?.emissions?.[k];
                if (item && typeof item.value !== 'undefined') {
                    const v = Number(item.value);
                    emissionsOut[k] = { value: Number.isFinite(v) ? v : 0, originalValue: Number.isFinite(v) ? v : 0 };
                }
            });
            timelineKeys.forEach(k => {
                const item = parsed?.timeline?.[k];
                if (item && typeof item.duration !== 'undefined') {
                    const d = Number(item.duration);
                    timelineOut[k] = { duration: Math.max(1, Math.floor(Number.isFinite(d) ? d : 1)), originalDuration: Math.max(1, Math.floor(Number.isFinite(d) ? d : 1)), unit: 'å¤©' };
                }
            });
            
            console.log('ğŸ“Š æ•´ç†åçš„ç³»ç»Ÿç»“æ„:', { emissions: emissionsOut, timeline: timelineOut });
            console.log('=================== AIåŸºç¡€æ•°æ®åˆ†æå®Œæˆ ===================\n');
            
            return { emissions: emissionsOut, timeline: timelineOut };
        }

        // æ­¥éª¤2: æ•°æ®åˆ†æ
        async function testDataAnalysis() {
            log('å¼€å§‹æ­¥éª¤2: æ•°æ®åˆ†æ');
            updateStatus('step2Status', 'running', 'åˆ†æä¸­...');
            
            try {
                log('ğŸ¤– è°ƒç”¨AIç”Ÿæˆç¢³æ’æ”¾ä¸æ—¶é—´çº¿åŸºç¡€æ•°æ®...');
                const aiData = await callAIForDataAnalysis();
                testState.analysisData = aiData;
                log('âœ“ ç¢³æ’æ”¾åˆ†æå®Œæˆ');
                log('âœ“ æ—¶é—´çº¿åˆ†æå®Œæˆ');
                updateStatus('step2Status', 'success', 'å®Œæˆ');
                showOutput('step2Output', testState.analysisData);
                return true;
            } catch (error) {
                // [MODIFIED] å›é€€åˆ°åŸæœ‰çš„æœ¬åœ°åŸºç¡€æ•°æ®é€»è¾‘ï¼Œç¡®ä¿åŠŸèƒ½ä¸ä¸­æ–­
                // Impact: å½“AIä¸å¯ç”¨æ—¶ï¼Œä¾ç„¶æä¾›å¯ç”¨çš„æ•°æ®ç»“æ„ï¼Œä¿éšœåç»­æµç¨‹å¯ç»§ç»­
                // Backward Compatibility: å®Œå…¨ä¿ç•™åŸæœ‰æœ¬åœ°æ•°æ®ç»“æ„ä¸å–å€¼èŒƒå›´
                log(`âš ï¸ AIåˆ†æå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨åŸºç¡€æ•°æ®: ${error.message}`, 'warning');
                testState.analysisData = {
                    emissions: {
                        procurement: { value: 85, originalValue: 85, defaultDiff: 35 },
                        manufacturing: { value: 140, originalValue: 140, defaultDiff: 45 },
                        logistics: { value: 40, originalValue: 40, defaultDiff: 15 },
                        usage: { value: 180, originalValue: 180, defaultDiff: 70 },
                        recycling: { value: 30, originalValue: 30, defaultDiff: 12 },
                        decomposition: { value: 15, originalValue: 15, defaultDiff: 5 }
                    },
                    timeline: {
                        purchase: { duration: 12, originalDuration: 12, unit: 'å‘¨é‡‡è´­å‘¨æœŸ' },
                        produce: { duration: 20, originalDuration: 20, unit: 'å‘¨ç”Ÿäº§å‘¨æœŸ' },
                        use: { duration: 120, originalDuration: 120, unit: 'ä¸ªæœˆä½¿ç”¨å¯¿å‘½' },
                        recycle: { duration: 6, originalDuration: 6, unit: 'ä¸ªæœˆæ‹†è§£å›æ”¶' },
                        decompose: { duration: 30, originalDuration: 30, unit: 'ä¸ªæœˆææ–™å¤„ç†' }
                    }
                };
                updateStatus('step2Status', 'success', 'å®Œæˆ(å›é€€)');
                showOutput('step2Output', testState.analysisData);
                return true;
            }
        }

        // æ­¥éª¤3: Leanå»ºè®®ç”Ÿæˆ
        async function testLeanSuggestions() {
            log('å¼€å§‹æ­¥éª¤3: Leanå»ºè®®ç”Ÿæˆ');
            updateStatus('step3Status', 'running', 'ç”Ÿæˆä¸­...');
            
            try {
                const areas = ['ææ–™é€‰æ‹©', 'ç”Ÿäº§å·¥è‰º', 'ä¾›åº”é“¾ç®¡ç†'];
                testState.leanSuggestions = {};
                testState.acceptedSuggestions = [];
                testState.acceptedSuggestionsByArea = {};
                
                // ä¸ºæ¯ä¸ªé¢†åŸŸè°ƒç”¨çœŸå®AIç”Ÿæˆå»ºè®®
                for (const area of areas) {
                    log(`ğŸ¤– ä¸º${area}é¢†åŸŸè°ƒç”¨AIç”Ÿæˆå»ºè®®...`);
                    const suggestions = await callAIForLeanSuggestions(area);
                    testState.leanSuggestions[area] = suggestions;
                    
                    // æ¨¡æ‹Ÿé‡‡çº³ç¬¬ä¸€ä¸ªå»ºè®®
                    if (suggestions && suggestions.length > 0) {
                        const acceptedTitle = suggestions[0].title;
                        testState.acceptedSuggestions.push(acceptedTitle);
                        testState.acceptedSuggestionsByArea[area] = [acceptedTitle];
                        log(`âœ“ é‡‡çº³å»ºè®®: ${acceptedTitle}`);
                    }
                }
                
                log('âœ“ å®Œæˆ3ä¸ªé¢†åŸŸçš„AIå»ºè®®ç”Ÿæˆ');
                log(`âœ“ å…±é‡‡çº³${testState.acceptedSuggestions.length}ä¸ªå»ºè®®`);
                updateStatus('step3Status', 'success', 'å®Œæˆ');
                showOutput('step3Output', {
                    suggestionsGenerated: Object.keys(testState.leanSuggestions).length,
                    acceptedSuggestions: testState.acceptedSuggestions,
                    acceptedByArea: testState.acceptedSuggestionsByArea
                });
                
                return true;
            } catch (error) {
                log(`âŒ æ­¥éª¤3å¤±è´¥: ${error.message}`, 'error');
                updateStatus('step3Status', 'error', 'å¤±è´¥');
                return false;
            }
        }

        // AI Leanå»ºè®®ç”Ÿæˆå‡½æ•°ï¼ˆå¤åˆ¶è‡ªindex_improved.htmlï¼‰
        async function callAIForLeanSuggestions(area) {
            const documentContent = testState.documentContent?.content || '';
            const supplementData = testState.supplementData || {};
            const productType = testState.documentContent?.documentType || 'automotive';
            const productTypeName = "æ±½è½¦åˆ¶é€ ";
            const analysisData = testState.analysisData || {};
            
            // å‡†å¤‡å­æ¨¡å—æ˜ å°„ä¸åŸºçº¿
            const carbonMapCN = {
                procurement: 'åŸæ–™é‡‡è´­',
                manufacturing: 'ç”Ÿäº§åˆ¶é€ ',
                logistics: 'ç‰©æµè¿è¾“',
                usage: 'äº§å“ä½¿ç”¨',
                recycling: 'å›æ”¶å¤„ç†',
                decomposition: 'è‡ªç„¶é™è§£'
            };
            const timeMapCN = {
                purchase: 'é‡‡è´­é˜¶æ®µ',
                produce: 'ç”Ÿäº§é˜¶æ®µ',
                use: 'ä½¿ç”¨é˜¶æ®µ',
                recycle: 'å›æ”¶é˜¶æ®µ',
                decompose: 'åˆ†è§£é˜¶æ®µ'
            };
            const carbonBaseline = {
                procurement: analysisData?.emissions?.procurement?.value ?? 85,
                manufacturing: analysisData?.emissions?.manufacturing?.value ?? 140,
                logistics: analysisData?.emissions?.logistics?.value ?? 40,
                usage: analysisData?.emissions?.usage?.value ?? 180,
                recycling: analysisData?.emissions?.recycling?.value ?? 30,
                decomposition: analysisData?.emissions?.decomposition?.value ?? 15
            };
            const timeBaseline = {
                purchase: analysisData?.timeline?.purchase?.duration ?? 12,
                produce: analysisData?.timeline?.produce?.duration ?? 20,
                use: analysisData?.timeline?.use?.duration ?? 120,
                recycle: analysisData?.timeline?.recycle?.duration ?? 6,
                decompose: analysisData?.timeline?.decompose?.duration ?? 30
            };

            // æ„å»ºAIæç¤ºè¯ï¼ˆä¸index_improved.htmlå®Œå…¨ä¸€è‡´ï¼‰
            const prompt = `ä½œä¸ºç¢³æ’æ”¾ç®¡ç†å’Œç²¾ç›Šç”Ÿäº§ä¸“å®¶ï¼Œè¯·ä¸º${productTypeName}äº§å“çš„${area}é¢†åŸŸç”Ÿæˆ3ä¸ªå…·ä½“çš„ä¼˜åŒ–å»ºè®®ã€‚

ã€äº§å“ä¿¡æ¯ã€‘ï¼š
äº§å“ç±»å‹ï¼š${productTypeName}
æ–‡æ¡£å†…å®¹ï¼š${documentContent.substring(0, 300)}...
è¡¥å……ä¿¡æ¯ï¼š${Object.entries(supplementData).map(([key, value]) => `${key}: ${value}`).join(', ')}

ã€ä¼˜åŒ–é¢†åŸŸã€‘ï¼š${area}

ã€å­æ¨¡å—ï¼ˆé”®â†’ä¸­æ–‡åï¼‰ã€‘
ç¢³æ’æ”¾ï¼š${JSON.stringify(carbonMapCN)}
æ—¶é—´ï¼š${JSON.stringify(timeMapCN)}

ã€å½“å‰åŸºçº¿ï¼ˆå•ä½ä¸¥æ ¼ç»Ÿä¸€ï¼‰ã€‘
ç¢³æ’æ”¾ï¼ˆkgCO2eï¼‰ï¼š${JSON.stringify(carbonBaseline)}
æ—¶é—´ï¼ˆå¤©ï¼‰ï¼š${JSON.stringify(timeBaseline)}

è¯·ä¸ºæ¯ä¸ªå»ºè®®æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰ï¼š
{
  "suggestions": [
    {
      "icon": "å¯¹åº”çš„FontAwesomeå›¾æ ‡ç±»å",
      "title": "å»ºè®®æ ‡é¢˜",
      "desc": "è¯¦ç»†çš„å»ºè®®æè¿°",
      "subProject": "å­é¡¹ç›®åç§°",
      "carbonAfter": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      "timeAfter": { "purchase": 0, "produce": 0, "use": 0, "recycle": 0, "decompose": 0 },
      "carbonImprovements": { "procurement": 0, "manufacturing": 0, "logistics": 0, "usage": 0, "recycling": 0, "decomposition": 0 },
      "timeImprovements": { "purchase": 0, "produce": 0, "use": 0, "recycle": 0, "decompose": 0 }
    }
  ]
}

è¦æ±‚ï¼ˆåŠ¡å¿…ä¸¥æ ¼éµå®ˆï¼‰ï¼š
1) å­æ¨¡å—ä¸å•ä½ï¼šæ‰€æœ‰ after å€¼å¿…é¡»ä¸åŸºçº¿é”®ä¸€ä¸€å¯¹åº”ï¼Œå•ä½ä¸¥æ ¼ä¸€è‡´ï¼ˆç¢³æ’=kgCO2eï¼Œæ—¶é—´=å¤©ï¼‰ã€‚
2) æ•°å€¼åˆæ³•æ€§ï¼štimeAfter å„é”®å¿…é¡»æ˜¯æ­£æ•´æ•°ï¼ˆ>=1ï¼‰ï¼›carbonAfter å„é”®å¿…é¡»æ˜¯éè´Ÿæ•°ï¼ˆ>=0ï¼‰ï¼Œå¯ä¿ç•™1ä½å°æ•°ã€‚
3) åˆç†èŒƒå›´ï¼štimeAfter[k] åº”åœ¨ [max(1, round(åŸºçº¿[k]*0.5)), round(åŸºçº¿[k]*1.3)] èŒƒå›´å†…ï¼›carbonAfter[k] åº”åœ¨ [0, åŸºçº¿[k]*1.3] èŒƒå›´å†…ã€‚
4) åªè¿”å›åˆæ³•JSONï¼›ç¡®ä¿ carbonImprovements å’Œ timeImprovements çš„é”®ä¸"å­æ¨¡å—ï¼ˆé”®â†’ä¸­æ–‡åï¼‰"å®Œå…¨å¯¹åº”ã€‚`;

            try {
                // ğŸ“¤ æ‰“å°AIè¾“å…¥ä¿¡æ¯
                console.log(`================== AI Leanå»ºè®®è°ƒç”¨ (${area}) ==================`);
                console.log('ğŸ”¹ APIç«¯ç‚¹:', 'https://api-inference.modelscope.cn/v1/chat/completions');
                console.log('ğŸ”¹ æ¨¡å‹:', 'deepseek-ai/DeepSeek-V3.1');
                console.log('ğŸ”¹ ä¼˜åŒ–é¢†åŸŸ:', area);
                console.log('ğŸ”¹ æç¤ºè¯é•¿åº¦:', prompt.length, 'å­—ç¬¦');
                console.log('ğŸ“¤ å®Œæ•´æç¤ºè¯:');
                console.log(prompt);
                console.log('ğŸ“¤ è¯·æ±‚å‚æ•°:', {
                    model: 'deepseek-ai/DeepSeek-V3.1',
                    max_tokens: 1500,
                    temperature: 0.7
                });
                console.log('ğŸ“¤ åŸºçº¿æ•°æ®:');
                console.log('ç¢³æ’æ”¾åŸºçº¿:', carbonBaseline);
                console.log('æ—¶é—´åŸºçº¿:', timeBaseline);
                
                const response = await fetch('/api/ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Client-Request': 'true'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-ai/DeepSeek-V3.1',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    console.log('âŒ AI APIå“åº”é”™è¯¯:', response.status, response.statusText);
                    throw new Error('AI APIè°ƒç”¨å¤±è´¥');
                }

                const data = await response.json();
                console.log('ğŸ“¥ AI APIå®Œæ•´å“åº”:', data);
                
                const aiResponse = data.choices[0].message.content;
                console.log('ğŸ“¥ AIè¿”å›å†…å®¹:', aiResponse);
                
                // è§£æAIè¿”å›çš„JSON
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    console.log('ğŸ” æå–çš„JSONå­—ç¬¦ä¸²:', jsonMatch[0]);
                    const suggestions = JSON.parse(jsonMatch[0]);
                    console.log('âœ… è§£æåçš„å»ºè®®ç»“æ„:', suggestions);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼å¹¶è¿”å›å»ºè®®æ•°ç»„
                    if (suggestions.suggestions && Array.isArray(suggestions.suggestions)) {
                        const processedSuggestions = suggestions.suggestions.map((suggestion, index) => {
                            console.log(`ğŸ”§ å¤„ç†å»ºè®® ${index + 1}:`, suggestion.title);
                            // ç¡®ä¿æœ‰æ”¹è¿›ç™¾åˆ†æ¯”æ•°æ®
                            if (!suggestion.carbonImprovements || !suggestion.timeImprovements) {
                                console.log('âš ï¸ å»ºè®®ç¼ºå°‘æ”¹è¿›æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                                suggestion.carbonImprovements = {
                                    procurement: 10, manufacturing: 15, logistics: 8,
                                    usage: 20, recycling: 5, decomposition: 2
                                };
                                suggestion.timeImprovements = {
                                    purchase: 10, produce: 15, use: 8,
                                    recycle: 12, decompose: 5
                                };
                            }
                            console.log(`âœ“ å»ºè®® ${index + 1} å¤„ç†å®Œæˆ:`, {
                                title: suggestion.title,
                                carbonImprovements: suggestion.carbonImprovements,
                                timeImprovements: suggestion.timeImprovements
                            });
                            return suggestion;
                        });
                        console.log(`================== AI Leanå»ºè®®å®Œæˆ (${area}) ==================\n`);
                        return processedSuggestions;
                    }
                }
                console.log('âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„å»ºè®®æ•°æ®ç»“æ„');
                throw new Error('AIè¿”å›æ ¼å¼é”™è¯¯');
            } catch (error) {
                log(`âš ï¸ AIå»ºè®®ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®: ${error.message}`, 'warning');
                
                // å¤‡ç”¨å»ºè®®æ•°æ®
                const fallbackSuggestions = {
                    'ææ–™é€‰æ‹©': [
                        {
                            title: `${productTypeName}ç”Ÿç‰©åŸºææ–™æ›¿ä»£`,
                            desc: `é’ˆå¯¹${productTypeName}ç‰¹ç‚¹ï¼Œé‡‡ç”¨ç”Ÿç‰©é™è§£ææ–™æ›¿ä»£ä¼ ç»Ÿææ–™ï¼Œå‡å°‘åŒ–å­¦å¤„ç†å·¥åºå’Œç¯å¢ƒå½±å“`,
                            icon: "fas fa-seedling",
                            subProject: "ç”Ÿç‰©åŸºææ–™é€‰æ‹©",
                            carbonImprovements: { procurement: 25, manufacturing: 15, logistics: 10, usage: 20, recycling: 8, decomposition: 5 },
                            timeImprovements: { purchase: 15, produce: 20, use: 10, recycle: 12, decompose: 8 }
                        }
                    ],
                    'ç”Ÿäº§å·¥è‰º': [
                        {
                            title: `${productTypeName}ç²¾ç›Šç”Ÿäº§æµç¨‹`,
                            desc: `é’ˆå¯¹${productTypeName}ç‰¹ç‚¹å®æ–½ç²¾ç›Šç”Ÿäº§ç†å¿µï¼Œæ¶ˆé™¤æµªè´¹å’Œå†—ä½™å·¥åº`,
                            icon: "fas fa-cogs",
                            subProject: "ç²¾ç›Šç”Ÿäº§æµç¨‹",
                            carbonImprovements: { procurement: 12, manufacturing: 40, logistics: 8, usage: 18, recycling: 5, decomposition: 2 },
                            timeImprovements: { purchase: 15, produce: 35, use: 8, recycle: 10, decompose: 3 }
                        }
                    ],
                    'ä¾›åº”é“¾ç®¡ç†': [
                        {
                            title: `${productTypeName}å°±è¿‘é‡‡è´­ç­–ç•¥`,
                            desc: `ä¸º${productTypeName}ä¼˜å…ˆé€‰æ‹©æœ¬åœ°ä¾›åº”å•†ï¼Œå‡å°‘è¿è¾“è·ç¦»å’Œæ—¶é—´`,
                            icon: "fas fa-map",
                            subProject: "å°±è¿‘é‡‡è´­ç­–ç•¥",
                            carbonImprovements: { procurement: 20, manufacturing: 5, logistics: 45, usage: 8, recycling: 5, decomposition: 2 },
                            timeImprovements: { purchase: 30, produce: 8, use: 5, recycle: 8, decompose: 2 }
                        }
                    ]
                };
                
                return fallbackSuggestions[area] || [];
            }
        }

        // æ­¥éª¤4: Scrumæ‰§è¡Œå›¾ç”Ÿæˆ
        async function testScrumGeneration() {
            log('å¼€å§‹æ­¥éª¤4: Scrumæ‰§è¡Œå›¾ç”Ÿæˆ');
            updateStatus('step4Status', 'running', 'ç”Ÿæˆä¸­...');
            
            try {
                await sleep(3000);
                
                // æ„å»ºAIæç¤ºè¯
                const prompt = buildScrumAIPrompt();
                log('âœ“ æ„å»ºAIæç¤ºè¯å®Œæˆ');
                
                // çœŸå®AIç”Ÿæˆæˆ–ä½¿ç”¨å›é€€æ–¹æ¡ˆ
                const plan = await generateScrumPlan();
                log('âœ“ Scrumè®¡åˆ’ç”Ÿæˆå®Œæˆ');
                
                // ç”Ÿæˆä»»åŠ¡æ•°æ®
                testState.scrumTasks = processScrumPlan(plan);
                log('âœ“ ä»»åŠ¡æ•°æ®å¤„ç†å®Œæˆ');
                
                updateStatus('step4Status', 'success', 'å®Œæˆ');
                showOutput('step4Output', {
                    sprint: plan.sprint,
                    tasksGenerated: plan.tasks.length,
                    scrumTasks: testState.scrumTasks
                });
                
                // æ˜¾ç¤ºç»“æœé¢„è§ˆ
                showResults();
                
                return true;
            } catch (error) {
                log(`âŒ æ­¥éª¤4å¤±è´¥: ${error.message}`, 'error');
                updateStatus('step4Status', 'error', 'å¤±è´¥');
                return false;
            }
        }

        // æ„å»ºScrum AIæç¤ºè¯
        function buildScrumAIPrompt() {
            const docContent = testState.documentContent ? testState.documentContent.content.slice(0, 2000) : '';
            const supplementData = testState.supplementData || {};
            const productTypeName = "æ±½è½¦åˆ¶é€ ";
            const analysis = testState.analysisData || {};
            const accepted = testState.acceptedSuggestions || [];
            const acceptedByArea = testState.acceptedSuggestionsByArea || {};
            
            // å°†ç¼“å­˜å»ºè®®æ‹å¹³
            const cachedSuggestions = [];
            Object.keys(testState.leanSuggestions || {}).forEach(area => {
                const items = (testState.leanSuggestions[area] || []).map(s => ({ area, title: s.title, desc: s.desc }));
                cachedSuggestions.push(...items);
            });
            
            const prompt = `ä½ æ˜¯æ•æ·é¡¹ç›®ç»ç†ã€‚è¯·åŸºäºä»¥ä¸‹çœŸå®ä¸Šä¸‹æ–‡ï¼Œä¸ºå½“å‰äº§å“ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œçš„Sprintä»»åŠ¡è®¡åˆ’ï¼ˆJSONï¼‰ã€‚

ã€äº§å“ç±»å‹ã€‘${productTypeName}
ã€æ–‡æ¡£æ‘˜è¦ã€‘${docContent}
ã€è¡¥å……ä¿¡æ¯ã€‘${JSON.stringify(supplementData)}
ã€å½“å‰åˆ†ææ•°æ®-ç¢³æ’ã€‘${JSON.stringify(analysis.emissions || {})}
ã€å½“å‰åˆ†ææ•°æ®-æ—¶é—´ã€‘${JSON.stringify(analysis.timeline || {})}
ã€å·²é‡‡çº³å»ºè®®ã€‘${JSON.stringify(accepted)}
ã€å»ºè®®ç¼“å­˜æ‘˜è¦ã€‘${JSON.stringify(cachedSuggestions).slice(0, 2000)}

è¯·è¾“å‡ºä¸¥æ ¼JSONï¼š{
  "sprint": {"name": "Sprint 1", "startDate": "YYYY-MM-DD", "endDate": "YYYY-MM-DD"},
  "tasks": [
    {"title":"","desc":"","assignee":"(å¯ä¸ºç©º)","priority":"high|medium|low","storyPoints":8,"startDate":"YYYY-MM-DD","endDate":"YYYY-MM-DD","status":"todo|in-progress|done","tags":["ææ–™é€‰æ‹©"],"relatedSuggestion":"(è‹¥æœ‰)"}
  ]
}

è¦æ±‚ï¼š
1) ä»»åŠ¡éœ€å¯æ‰§è¡Œï¼Œè¦†ç›–å…³é”®å·²é‡‡çº³å»ºè®®æˆ–é«˜å½±å“æ¿å—ï¼›
2) æ‰€æœ‰æ—¶é—´ä»¥æ—¥ä¸ºæœ€å°å•ä½ï¼Œä»»åŠ¡æŒç»­æ—¶é—´1-30å¤©ï¼Œæ—¥æœŸåˆç†ç”±è¿‘åˆ°è¿œï¼›
3) startDateå’ŒendDateå¿…é¡»æ˜¯æœ‰æ•ˆçš„YYYY-MM-DDæ ¼å¼æ—¥æœŸï¼›
4) å¦‚æ— æ˜ç¡®è´Ÿè´£äººï¼Œassigneeç•™ç©ºï¼›
5) ä¸¥æ ¼è¿”å›JSONï¼Œä¸è¦å¤šä½™æ–‡æœ¬ã€‚`;
            
            return prompt;
        }

        // ç”ŸæˆScrumè®¡åˆ’ï¼ˆä¸index_improved.htmlå®Œå…¨ä¸€è‡´ï¼‰
        async function generateScrumPlan() {
            const prompt = buildScrumAIPrompt();
            
            try {
                // ğŸ“¤ æ‰“å°AIè¾“å…¥ä¿¡æ¯
                console.log('================== AI Scrumè®¡åˆ’è°ƒç”¨ ==================');
                console.log('ğŸ”¹ APIç«¯ç‚¹:', 'https://api-inference.modelscope.cn/v1/chat/completions');
                console.log('ğŸ”¹ æ¨¡å‹:', 'deepseek-ai/DeepSeek-V3.1');
                console.log('ğŸ”¹ æç¤ºè¯é•¿åº¦:', prompt.length, 'å­—ç¬¦');
                console.log('ğŸ“¤ å®Œæ•´æç¤ºè¯:');
                console.log(prompt);
                console.log('ğŸ“¤ è¯·æ±‚å‚æ•°:', {
                    model: 'deepseek-ai/DeepSeek-V3.1',
                    max_tokens: 1200,
                    temperature: 0.5
                });
                console.log('ğŸ“¤ ä¸Šä¸‹æ–‡æ•°æ®:');
                console.log('æ–‡æ¡£å†…å®¹é•¿åº¦:', testState.documentContent?.content?.length || 0);
                console.log('è¡¥å……æ•°æ®:', testState.supplementData);
                console.log('å·²é‡‡çº³å»ºè®®:', testState.acceptedSuggestions);
                console.log('åˆ†ææ•°æ®:', testState.analysisData);
                
                log('ğŸ¤– è°ƒç”¨AIç”ŸæˆScrumè®¡åˆ’...');
                const response = await fetch('/api/ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Client-Request': 'true'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-ai/DeepSeek-V3.1',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1200,
                        temperature: 0.5
                    })
                });
                
                if (!response.ok) {
                    console.log('âŒ AI APIå“åº”é”™è¯¯:', response.status, response.statusText);
                    throw new Error('AIç”Ÿæˆå¤±è´¥');
                }
                
                const data = await response.json();
                console.log('ğŸ“¥ AI APIå®Œæ•´å“åº”:', data);
                
                const content = data.choices?.[0]?.message?.content || '';
                console.log('ğŸ“¥ AIè¿”å›å†…å®¹:', content);
                
                const match = content.match(/\{[\s\S]*\}/);
                
                if (match) {
                    console.log('ğŸ” æå–çš„JSONå­—ç¬¦ä¸²:', match[0]);
                    const plan = JSON.parse(match[0]);
                    console.log('âœ… è§£æåçš„Scrumè®¡åˆ’:', plan);
                    console.log('âœ“ AIæˆåŠŸç”ŸæˆScrumè®¡åˆ’');
                    console.log('Sprintä¿¡æ¯:', plan.sprint);
                    console.log('ä»»åŠ¡æ•°é‡:', plan.tasks?.length || 0);
                    console.log('================== AI Scrumè®¡åˆ’å®Œæˆ ==================\n');
                    log('âœ“ AIæˆåŠŸç”ŸæˆScrumè®¡åˆ’');
                    return plan;
                }
                
                console.log('âŒ æœªæ‰¾åˆ°JSONæ ¼å¼å†…å®¹');
                throw new Error('AIè¿”å›æ ¼å¼é”™è¯¯');
            } catch (e) {
                log(`âš ï¸ AIä¸å¯ç”¨ï¼Œä½¿ç”¨è§„åˆ™å›é€€ç”Ÿæˆ: ${e.message}`, 'warning');
                return buildScrumPlanFallback();
            }
        }

        // å›é€€æ–¹æ¡ˆç”ŸæˆScrumè®¡åˆ’
        function buildScrumPlanFallback() {
            const tasks = [];
            const today = new Date();
            let dayOffset = 0;
            
            // åŸºäºå·²é‡‡çº³å»ºè®®ç”Ÿæˆä»»åŠ¡
            Object.keys(testState.acceptedSuggestionsByArea || {}).forEach(area => {
                (testState.acceptedSuggestionsByArea[area] || []).forEach((title, idx) => {
                    const start = new Date(today.getTime() + dayOffset*86400000);
                    const end = new Date(start.getTime() + (3 + (idx%3))*86400000);
                    tasks.push({
                        title: `${area} - æ‰§è¡Œã€Œ${title}ã€`,
                        desc: 'æ ¹æ®å·²é‡‡çº³å»ºè®®è½å®æ‰§è¡Œã€éªŒè¯ä¸å¤ç›˜',
                        assignee: ['å¼ æ˜', 'æå', 'ç‹èŠ³', 'é™ˆå¼º'][idx % 4],
                        priority: idx%2===0 ? 'high' : 'medium',
                        storyPoints: [5,8,13,3][idx%4],
                        startDate: start.toISOString().slice(0,10),
                        endDate: end.toISOString().slice(0,10),
                        status: idx%3===0 ? 'in-progress' : 'todo',
                        tags: [area],
                        relatedSuggestion: title
                    });
                    dayOffset += 2;
                });
            });
            
            // åŸºäºé«˜æ’æ”¾ç¯èŠ‚ç”Ÿæˆè¡¥å……ä»»åŠ¡
            if (testState.analysisData?.emissions) {
                const sorted = Object.entries(testState.analysisData.emissions)
                    .sort((a,b)=> (b[1].value||0) - (a[1].value||0))
                    .slice(0,2);
                    
                sorted.forEach(([key, value], i) => {
                    const start = new Date(today.getTime() + dayOffset*86400000);
                    const end = new Date(start.getTime() + 4*86400000);
                    const phaseNames = {
                        procurement: 'åŸæ–™é‡‡è´­',
                        manufacturing: 'ç”Ÿäº§åˆ¶é€ ',
                        logistics: 'ç‰©æµè¿è¾“',
                        usage: 'äº§å“ä½¿ç”¨',
                        recycling: 'å›æ”¶å¤„ç†',
                        decomposition: 'è‡ªç„¶é™è§£'
                    };
                    tasks.push({
                        title: `ä¼˜åŒ–ã€Œ${phaseNames[key] || key}ã€é˜¶æ®µæ’æ”¾`,
                        desc: 'åˆ¶å®šå¹¶æ‰§è¡Œé™ç¢³ä¸¾æªï¼Œè·Ÿè¸ªå…³é”®æŒ‡æ ‡',
                        assignee: ['åˆ˜æ´‹', 'èµµæ•'][i],
                        priority: i===0?'high':'medium',
                        storyPoints: [8,5][i],
                        startDate: start.toISOString().slice(0,10),
                        endDate: end.toISOString().slice(0,10),
                        status: 'todo',
                        tags: ['é™ç¢³', 'æ•°æ®é©±åŠ¨'],
                        relatedSuggestion: null
                    });
                    dayOffset += 3;
                });
            }
            
            return {
                sprint: {
                    name: "EcoLoopç”µåŠ¨æ±½è½¦ç¢³ä¼˜åŒ–Sprint 1",
                    startDate: today.toISOString().slice(0,10),
                    endDate: new Date(today.getTime() + 14*86400000).toISOString().slice(0,10)
                },
                tasks: tasks
            };
        }

        // å¤„ç†Scrumè®¡åˆ’
        function processScrumPlan(plan) {
            console.log('================ Scrumè®¡åˆ’æ•°æ®å¤„ç† ================');
            console.log('ğŸ“‹ è¾“å…¥è®¡åˆ’:', plan);
            
            const buckets = { 'todo': [], 'in-progress': [], 'done': [] };
            const tasks = Array.isArray(plan?.tasks) ? plan.tasks : [];
            console.log('ğŸ“‹ æå–çš„ä»»åŠ¡æ•°ç»„:', tasks);
            console.log('ğŸ“‹ ä»»åŠ¡æ•°é‡:', tasks.length);
            
            const normalizePriority = (p) => (p==='high'||p==='medium'||p==='low') ? p : 'medium';
            const normalizeStatus = (s) => (s==='todo'||s==='in-progress'||s==='done') ? s : 'todo';
            
            tasks.forEach((t, idx) => {
                console.log(`ğŸ”§ å¤„ç†ä»»åŠ¡ ${idx + 1}:`, t.title);
                const task = {
                    id: `test-${Date.now()}-${idx}`,
                    title: t.title || `ä»»åŠ¡${idx+1}`,
                    description: t.desc || '',
                    assignee: t.assignee || '',
                    priority: normalizePriority(t.priority),
                    storyPoints: Number.isFinite(t.storyPoints) ? t.storyPoints : 5,
                    startDate: t.startDate || new Date().toISOString().slice(0,10),
                    endDate: t.endDate || new Date(Date.now()+3*86400000).toISOString().slice(0,10),
                    tags: Array.isArray(t.tags) ? t.tags : [],
                    relatedSuggestion: t.relatedSuggestion || null,
                    progress: t.status==='in-progress' ? 30 : (t.status==='done'? 100 : undefined)
                };
                const status = normalizeStatus(t.status);
                buckets[status].push(task);
                console.log(`âœ“ ä»»åŠ¡ ${idx + 1} åˆ†é…åˆ°çŠ¶æ€: ${status}`, {
                    title: task.title,
                    priority: task.priority,
                    storyPoints: task.storyPoints,
                    assignee: task.assignee
                });
            });
            
            const finalData = Object.assign(buckets, { __auto: true });
            console.log('ğŸ“Š æœ€ç»ˆåˆ†æ¡¶ç»“æœ:');
            console.log('  - todo:', finalData.todo.length, 'ä¸ªä»»åŠ¡');
            console.log('  - in-progress:', finalData['in-progress'].length, 'ä¸ªä»»åŠ¡');
            console.log('  - done:', finalData.done.length, 'ä¸ªä»»åŠ¡');
            console.log('âœ… æ•°æ®ç»“æ„éªŒè¯:');
            console.log('  - todoæ˜¯æ•°ç»„:', Array.isArray(finalData.todo));
            console.log('  - in-progressæ˜¯æ•°ç»„:', Array.isArray(finalData['in-progress']));
            console.log('  - doneæ˜¯æ•°ç»„:', Array.isArray(finalData.done));
            console.log('  - __autoæ ‡è®°:', finalData.__auto);
            console.log('================ Scrumè®¡åˆ’å¤„ç†å®Œæˆ ================\n');
            
            return finalData;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('resultPreview').style.display = 'block';
            
            // æ¸²æŸ“Kanbané¢„è§ˆ
            renderKanbanPreview();
            
            // æ¸²æŸ“ç”˜ç‰¹å›¾é¢„è§ˆ
            renderGanttPreview();
            
            log('âœ… ç»“æœé¢„è§ˆç”Ÿæˆå®Œæˆ', 'success');
        }

        // æ¸²æŸ“Kanbané¢„è§ˆ
        function renderKanbanPreview() {
            const kanbanContainer = document.getElementById('kanbanPreview');
            const statusNames = {
                'todo': 'å¾…åŠäº‹é¡¹',
                'in-progress': 'è¿›è¡Œä¸­',
                'done': 'å·²å®Œæˆ'
            };
            
            let html = '';
            Object.keys(statusNames).forEach(status => {
                const tasks = testState.scrumTasks[status] || [];
                html += `
                    <div class="kanban-column">
                        <h4>${statusNames[status]} (${tasks.length})</h4>
                        ${tasks.map(task => `
                            <div class="task-item">
                                <strong>${task.title}</strong><br>
                                <small>${task.assignee} â€¢ ${task.storyPoints}SP</small>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            kanbanContainer.innerHTML = html;
        }

        // æ¸²æŸ“ç”˜ç‰¹å›¾é¢„è§ˆ
        function renderGanttPreview() {
            const ganttContainer = document.getElementById('ganttPreview');
            const allTasks = [];
            
            Object.keys(testState.scrumTasks).forEach(status => {
                if (status !== '__auto' && status !== '__aiGenerated' && Array.isArray(testState.scrumTasks[status])) {
                    allTasks.push(...testState.scrumTasks[status]);
                }
            });
            
            const statusColors = {
                'todo': '#6c757d',
                'in-progress': '#ffc107',
                'done': '#28a745'
            };
            
            let html = '<div class="gantt-timeline">';
            allTasks.forEach(task => {
                const status = Object.keys(testState.scrumTasks).find(s => 
                    s !== '__auto' && testState.scrumTasks[s].includes(task)
                ) || 'todo';
                
                html += `
                    <div class="gantt-bar" style="background: ${statusColors[status]}; width: ${task.storyPoints * 10}%;">
                        ${task.title} (${task.assignee})
                    </div>
                `;
            });
            html += '</div>';
            
            ganttContainer.innerHTML = html;
        }

        // æ˜¾ç¤ºAIæç¤ºè¯
        function showAIPrompt() {
            const prompt = buildScrumAIPrompt();
            showOutput('aiPromptOutput', prompt);
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            log('=== å¼€å§‹å®Œæ•´æµ‹è¯• ===', 'success');
            testState.testStartTime = Date.now();
            updateStatus('globalStatus', 'running', 'æµ‹è¯•ä¸­...');
            
            try {
                // æ­¥éª¤1
                updateProgress(10);
                if (!(await testDocumentProcessing())) throw new Error('æ­¥éª¤1å¤±è´¥');
                
                // æ­¥éª¤2
                updateProgress(35);
                if (!(await testDataAnalysis())) throw new Error('æ­¥éª¤2å¤±è´¥');
                
                // æ­¥éª¤3
                updateProgress(60);
                if (!(await testLeanSuggestions())) throw new Error('æ­¥éª¤3å¤±è´¥');
                
                // æ­¥éª¤4
                updateProgress(85);
                if (!(await testScrumGeneration())) throw new Error('æ­¥éª¤4å¤±è´¥');
                
                updateProgress(100);
                updateStatus('globalStatus', 'success', 'æµ‹è¯•å®Œæˆ');
                
                const duration = ((Date.now() - testState.testStartTime) / 1000).toFixed(1);
                log(`=== å®Œæ•´æµ‹è¯•æˆåŠŸå®Œæˆ (è€—æ—¶: ${duration}ç§’) ===`, 'success');
                
            } catch (error) {
                updateStatus('globalStatus', 'error', 'æµ‹è¯•å¤±è´¥');
                log(`=== æµ‹è¯•å¤±è´¥: ${error.message} ===`, 'error');
            }
        }

        // åˆ†æ­¥æ‰§è¡Œ
        async function runStepByStep() {
            log('=== å¼€å§‹åˆ†æ­¥æ‰§è¡Œ ===');
            
            const steps = [
                { func: testDocumentProcessing, name: 'æ–‡æ¡£å¤„ç†' },
                { func: testDataAnalysis, name: 'æ•°æ®åˆ†æ' },
                { func: testLeanSuggestions, name: 'Leanå»ºè®®' },
                { func: testScrumGeneration, name: 'Scrumç”Ÿæˆ' }
            ];
            
            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                const result = confirm(`æ‰§è¡Œæ­¥éª¤${i+1}: ${step.name}?`);
                if (result) {
                    log(`æ‰‹åŠ¨æ‰§è¡Œæ­¥éª¤${i+1}: ${step.name}`);
                    updateProgress((i+1) * 25);
                    await step.func();
                } else {
                    log(`è·³è¿‡æ­¥éª¤${i+1}: ${step.name}`, 'warning');
                }
            }
            
            log('=== åˆ†æ­¥æ‰§è¡Œå®Œæˆ ===');
        }

        // é‡ç½®æµ‹è¯•
        function resetTest() {
            log('=== é‡ç½®æµ‹è¯•çŠ¶æ€ ===', 'warning');
            
            testState = {
                currentStep: 0,
                totalSteps: 4,
                documentContent: null,
                supplementData: null,
                analysisData: null,
                leanSuggestions: null,
                acceptedSuggestions: null,
                scrumTasks: null,
                testStartTime: null
            };
            
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            ['step1Status', 'step2Status', 'step3Status', 'step4Status', 'globalStatus'].forEach(id => {
                updateStatus(id, 'pending', 'å¾…å¼€å§‹');
            });
            
            // éšè—è¾“å‡º
            ['step1Output', 'step2Output', 'step3Output', 'step4Output', 'aiPromptOutput'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            // é‡ç½®è¿›åº¦å’Œç»“æœ
            updateProgress(0);
            document.getElementById('resultPreview').style.display = 'none';
            document.getElementById('noResults').style.display = 'block';
            
            log('æµ‹è¯•çŠ¶æ€å·²é‡ç½®');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('testLog').textContent = '=== Scrumæ‰§è¡Œå›¾ç”ŸæˆåŠŸèƒ½æµ‹è¯•æ—¥å¿— ===\\nç­‰å¾…æµ‹è¯•å¼€å§‹...';
        }

        // å·¥å…·å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ Scrumæ‰§è¡Œå›¾æµ‹è¯•å·¥å…·å·²å°±ç»ª');
            log('ğŸ¤– çœŸå®AIé›†æˆæµ‹è¯•ï¼šæ­¥éª¤1+3+4éƒ½è°ƒç”¨DeepSeek-V3.1 API');
            log('ğŸ“‹ å®Œæ•´æµç¨‹ï¼šæ–‡æ¡£AIè¡¥å…¨ â†’ æ•°æ®åˆ†æ â†’ AI Leanå»ºè®® â†’ AI Scrumç”Ÿæˆ');
            log('ğŸ”„ åŒ…å«å®¹é”™æœºåˆ¶ï¼šAIå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°è§„åˆ™ç”Ÿæˆ');
            log('ğŸ’¡ ç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"å¼€å§‹çœŸå®AIæµ‹è¯•');
            log('ğŸ“º æ‰€æœ‰AIè¾“å…¥è¾“å‡ºå°†åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¯¦ç»†æ˜¾ç¤º');
            console.log('%cğŸ¯ AIè°ƒè¯•æ¨¡å¼å·²å¯ç”¨', 'color: #2196F3; font-weight: bold; font-size: 14px;');
            console.log('%cğŸ“± æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ‰€æœ‰AIè°ƒç”¨çš„è¯¦ç»†è¾“å…¥è¾“å‡º', 'color: #4CAF50; font-size: 12px;');
        });
    </script>
</body>
</html>
